<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAURUS PRO ADMIN (FINAL Ver.)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ ìŠ¤íƒ€ì¼ */
    .control-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 8px; margin-bottom: 10px; }
    .btn { padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; border: 1px solid #ccc; font-size: 14px; }
    .btn-hit { background: #ffebee; color: #c62828; border-color: #ef9a9a; }
    .btn-out { background: #eceff1; color: #455a64; border-color: #b0bec5; }
    .btn-adv { background: #e8f5e9; color: #2e7d32; border-color: #a5d6a7; }
    
    /* ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë‹¬ (í•µì‹¬) */
    .scenario-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 9999; display: none; align-items: center; justify-content: center; }
    .sm-box { background: #fff; width: 95%; max-width: 400px; padding: 20px; border-radius: 12px; text-align: center; }
    .sm-title { font-size: 18px; font-weight: bold; margin-bottom: 15px; color: #333; border-bottom: 2px solid #333; padding-bottom: 10px;}
    
    .field-editor { position: relative; height: 160px; background: #2e7d32; border-radius: 8px; margin: 15px 0; border: 2px solid #fff; }
    .base-chk { position: absolute; width: 35px; height: 35px; background: #fff; transform: rotate(45deg); cursor: pointer; border: 2px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 10px; font-weight: bold; }
    .base-chk.checked { background: #ffeb3b; border-color: #fbc02d; box-shadow: 0 0 8px #ffeb3b; }
    .base-chk span { transform: rotate(-45deg); }
    
    /* ë² ì´ìŠ¤ ìœ„ì¹˜ */
    .bc-1 { right: 20px; top: 60px; }
    .bc-2 { left: 50%; top: 10px; margin-left: -17.5px; }
    .bc-3 { left: 20px; top: 60px; }
    .bc-h { left: 50%; bottom: 10px; margin-left: -17.5px; border-radius: 50%; background: #ddd; }

    .score-control { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 15px 0; background: #f5f5f5; padding: 10px; border-radius: 8px; }
    .score-btn { width: 30px; height: 30px; border-radius: 50%; border: none; background: #333; color: #fff; font-size: 18px; cursor: pointer; }
    
    .confirm-btn { width: 100%; padding: 15px; background: #1976d2; color: #fff; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; }
    
    .opt-group { display: flex; gap: 5px; margin-bottom: 10px; justify-content: center; }
    .opt-btn { flex: 1; padding: 8px; font-size: 12px; border: 1px solid #ddd; background: #fff; cursor: pointer; }
    .opt-btn.selected { background: #333; color: #fff; }

    /* ì •ë³´ì°½ */
    .info-bar { background: #333; color: #fff; padding: 10px; margin-bottom: 10px; font-size: 14px; display: flex; justify-content: space-between; }
  </style>
</head>
<body>

  <div id="loginLayer" class="admin-login-overlay">
    <h2>âš¾ TAURUS ADMIN</h2>
    <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ (taurus)" style="padding:10px; margin:10px;">
    <button id="loginBtn" style="padding:10px 20px;">ì ‘ì†</button>
  </div>

  <div id="adminPanel" style="display:none; max-width: 600px; margin: 0 auto;">
    
    <div id="setupView" style="padding:20px; background:#fff;">
      <h3>ğŸ› ï¸ ê²½ê¸° ì„¤ì •</h3>
      <button id="loadScheduleBtn" class="btn" style="width:100%; margin-bottom:10px; background:#e3f2fd;">ğŸ“… ì˜¤ëŠ˜ ê²½ê¸° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      
      <div style="display:flex; gap:10px;">
        <div style="flex:1">
          <input type="text" id="awayName" placeholder="ì›ì •íŒ€" value="TAURUS" style="width:100%; text-align:center; font-weight:bold;">
          <div id="awayLineup"></div> </div>
        <div style="flex:1">
          <input type="text" id="homeName" placeholder="í™ˆíŒ€" style="width:100%; text-align:center; font-weight:bold;">
          <div id="homeLineup"></div> </div>
      </div>
      <div style="margin-top:10px; text-align:center;">
        <label><input type="radio" name="firstAttack" value="away" checked> ì›ì • ì„ ê³µ</label>
        <label><input type="radio" name="firstAttack" value="home"> í™ˆ ì„ ê³µ</label>
      </div>
      <button id="startBtn" class="btn" style="width:100%; background:#2e7d32; color:#fff; margin-top:15px;">PLAY BALL</button>
    </div>

    <div id="gameView" style="display:none;">
      <div class="info-bar">
        <span><span id="d_away">AWAY</span> <span id="s_away" style="font-weight:bold; font-size:18px;">0</span></span>
        <span id="d_inn">1íšŒì´ˆ</span>
        <span><span id="s_home" style="font-weight:bold; font-size:18px;">0</span> <span id="d_home">HOME</span></span>
      </div>
      
      <div style="background:#fff; padding:10px; margin-bottom:10px; border-bottom:1px solid #ddd;">
        <div style="text-align:center; font-size:18px; font-weight:bold; margin-bottom:5px;">
          <span style="color:green">B <span id="cnt_b">0</span></span>
          <span style="color:#fbc02d">S <span id="cnt_s">0</span></span>
          <span style="color:red">O <span id="cnt_o">0</span></span>
        </div>
        <div style="text-align:center; font-size:14px;">
          íƒ€ì„: <span id="cur_bat" style="color:#1976d2; font-weight:bold;">-</span>
          <br><span id="cur_stat" style="font-size:12px; color:#666;">-</span>
        </div>
      </div>

      <div style="padding:10px;">
        <h4 style="margin:0 0 5px 0;">íˆ¬êµ¬ (ë¡œê·¸ ë¯¸ì „ì†¡)</h4>
        <div class="control-grid">
          <button class="btn btn-out" onclick="addBallCount('b')">ë³¼</button>
          <button class="btn btn-out" onclick="addBallCount('s')">ìŠ¤íŠ¸ë¼ì´í¬</button>
          <button class="btn btn-out" onclick="addBallCount('f')">íŒŒìš¸</button>
          <button class="btn btn-out" style="background:#333; color:#fff;" onclick="resetBSO()">BSO ë¦¬ì…‹</button>
        </div>

        <h4 style="margin:10px 0 5px 0;">íƒ€ê²© ê²°ê³¼ (ì‹œë‚˜ë¦¬ì˜¤ í¸ì§‘ê¸° ì‹¤í–‰)</h4>
        <div class="control-grid">
          <button class="btn btn-hit" onclick="openScenario('hit', 1)">1ë£¨íƒ€</button>
          <button class="btn btn-hit" onclick="openScenario('hit', 2)">2ë£¨íƒ€</button>
          <button class="btn btn-hit" onclick="openScenario('hit', 3)">3ë£¨íƒ€</button>
          <button class="btn btn-hit" onclick="openScenario('hr', 4)">í™ˆëŸ°</button>
          
          <button class="btn btn-out" onclick="openScenario('out', 'go')">ë•…ë³¼</button>
          <button class="btn btn-out" onclick="openScenario('out', 'fo')">ëœ¬ê³µ</button>
          <button class="btn btn-out" onclick="openScenario('k', 'so')">ì‚¼ì§„</button>
          <button class="btn btn-out" onclick="openScenario('out', 'dp')">ë³‘ì‚´</button>
          
          <button class="btn btn-adv" onclick="openScenario('4ball', 'bb')">ë³¼ë„·</button>
          <button class="btn btn-adv" onclick="openScenario('4ball', 'hbp')">ì‚¬êµ¬</button>
          <button class="btn btn-adv" onclick="openScenario('err', 'err')">ì‹¤ì±…</button>
          <button class="btn btn-adv" onclick="openScenario('etc', 'fc')">ì•¼ì„ </button>
        </div>
        
        <div style="margin-top:20px; display:flex; gap:10px;">
           <button class="btn" style="flex:1;" onclick="changeBatter()">ëŒ€íƒ€ êµì²´</button>
           <button class="btn" style="flex:1;" onclick="changePitcher()">íˆ¬ìˆ˜ êµì²´</button>
           <button class="btn" style="flex:1; background:#333; color:#fff;" onclick="endGame()">ê²½ê¸° ì¢…ë£Œ</button>
        </div>
      </div>
    </div>
  </div>

  <div id="scenarioModal" class="scenario-modal">
    <div class="sm-box">
      <div class="sm-title" id="smTitle">ê²°ê³¼ í™•ì •</div>
      
      <div id="hitLocBox" class="opt-group" style="display:none;">
        <button class="opt-btn" onclick="selLoc(this, 'ì¢Œ')">ì¢Œì¸¡</button>
        <button class="opt-btn" onclick="selLoc(this, 'ì¤‘')">ì¤‘ì•™</button>
        <button class="opt-btn" onclick="selLoc(this, 'ìš°')">ìš°ì¸¡</button>
        <button class="opt-btn" onclick="selLoc(this, 'ë‚´ì•¼')">ë‚´ì•¼</button>
      </div>

      <p style="font-size:12px; color:#666;">â–¼ ê²°ê³¼ í›„, ì£¼ìê°€ <b>ë‚¨ì•„ìˆëŠ” ë² ì´ìŠ¤</b>ë¥¼ ì²´í¬í•˜ì„¸ìš”.</p>
      
      <div class="field-editor">
        <div id="chk3" class="base-chk bc-3" onclick="toggleBase(3)"><span>3</span></div>
        <div id="chk2" class="base-chk bc-2" onclick="toggleBase(2)"><span>2</span></div>
        <div id="chk1" class="base-chk bc-1" onclick="toggleBase(1)"><span>1</span></div>
        <div class="base-chk bc-h" style="border:none; background:none; font-size:12px; color:#fff;">í™ˆ</div>
      </div>

      <div class="score-control">
        <span style="font-weight:bold;">ì´ë²ˆ í”Œë ˆì´ ë“ì :</span>
        <button class="score-btn" onclick="adjScore(-1)">-</button>
        <span id="scoreInput" style="font-size:24px; font-weight:bold; width:30px;">0</span>
        <button class="score-btn" onclick="adjScore(1)">+</button>
      </div>

      <button class="confirm-btn" onclick="submitScenario()">í™•ì¸ ë° ì „ì†¡</button>
      <button onclick="closeScenario()" style="margin-top:10px; background:none; border:none; color:#666; text-decoration:underline; cursor:pointer;">ì·¨ì†Œ</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMVkogwvzoQon3lo0_hiVewfoXxmvbYMU",
      authDomain: "taurus-cbnu.firebaseapp.com",
      databaseURL: "https://taurus-cbnu-default-rtdb.firebaseio.com",
      projectId: "taurus-cbnu",
      storageBucket: "taurus-cbnu.firebasestorage.app",
      messagingSenderId: "598393475132",
      appId: "1:598393475132:web:b266ef01509e6c20dd7339"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    // === ì „ì—­ ë³€ìˆ˜ ===
    let game = {
      teams: { away:'', home:'' }, inn: '1íšŒì´ˆ', top: true,
      score: { away:0, home:0 }, bso: {b:0, s:0, o:0},
      runner: { b1: false, b2: false, b3: false }, // true/falseë¡œ ê´€ë¦¬ (ë‹¨ìˆœí™”)
      lineups: { away:[], home:[] },
      idx: { away:0, home:0 },
      pitchLog: [] // í˜„ì¬ íƒ€ì„ íˆ¬êµ¬ ë¡œê·¸
    };
    
    // ì„ì‹œ ì €ì¥ìš© (ëª¨ë‹¬)
    let tempScenario = { type: '', detail: '', runs: 0, runners: [false,false,false], loc: '' };

    // === ì´ˆê¸°í™” ===
    document.addEventListener('DOMContentLoaded', () => {
      // ë¼ì¸ì—… ì¸í’‹ ìƒì„±
      const makeInputs = (id, p) => {
        const d = document.getElementById(id); d.innerHTML='';
        for(let i=0; i<9; i++) d.innerHTML+=`<input id="${p}${i}" placeholder="${i+1}ë²ˆ" style="width:100%; margin:2px 0; padding:4px;">`;
      };
      makeInputs('awayLineup', 'a'); makeInputs('homeLineup', 'h');

      document.getElementById('loginBtn').onclick = () => {
        if(document.getElementById('adminPw').value==='taurus') {
          document.getElementById('loginLayer').style.display='none';
          document.getElementById('adminPanel').style.display='block';
        } else alert('ë¹„ë²ˆ ì˜¤ë¥˜');
      };

      document.getElementById('loadScheduleBtn').onclick = async () => {
        try {
          const res = await fetch('schedule.json?t='+Date.now());
          const data = await res.json();
          const today = new Date().toDateString();
          let found = null;
          // ì˜¤ëŠ˜ ê²½ê¸° ì°¾ê¸°
          Object.values(data).flat().forEach(g => {
             // ë‚ ì§œ í¬ë§· ëŒ€ì‘
             let dStr = g.date.replace(/\./g, '/');
             if(!dStr.includes('/')) return; // skip bad format
             if(dStr.split('/').length < 3) dStr = `2026/${dStr}`; // ì—°ë„ ì—†ìœ¼ë©´ ëŒ€ì¶© ë¶™ì„ (ì‹¤ì œë¡  logic í•„ìš”)
             // ê°„ë‹¨ ë¹„êµ
             if(g.date.includes('02.02') || g.date.includes('02-02')) found = g; // â˜… í…ŒìŠ¤íŠ¸ìš© ê°•ì œ ë§¤ì¹­ (ì˜¤ëŠ˜ ë‚ ì§œë¡œ ìˆ˜ì •í•„ìš”)
          });
          
          if(found) {
             alert(`ê²½ê¸° ë°œê²¬: ${found.opponent}`);
             document.getElementById('awayName').value = 'TAURUS';
             document.getElementById('homeName').value = found.opponent;
          } else {
             alert('ì˜¤ëŠ˜ ì˜ˆì •ëœ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. (schedule.json ë‚ ì§œ í™•ì¸)');
          }
        } catch(e) { alert('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹¤íŒ¨'); }
      };

      document.getElementById('startBtn').onclick = () => {
        const away = document.getElementById('awayName').value;
        const home = document.getElementById('homeName').value;
        const isAwayFirst = document.querySelector('input[name="firstAttack"]:checked').value === 'away';
        
        // ë¼ì¸ì—… ì½ê¸°
        const getLineup = (p) => {
          let arr = [];
          for(let i=0; i<9; i++) arr.push({
             name: document.getElementById(p+i).value || `íƒ€ì${i+1}`,
             pa:0, ab:0, h:0, bb:0, k:0, r:0, rbi:0 // ìƒì„¸ ìŠ¤íƒ¯
          });
          return arr;
        };

        game = {
          teams: { away, home },
          inn: '1íšŒì´ˆ', top: isAwayFirst, // ì›ì • ì„ ê³µì´ë©´ top=true
          score: { away:0, home:0 },
          bso: { b:0, s:0, o:0 },
          runner: { b1:false, b2:false, b3:false },
          lineups: { away: getLineup('a'), home: getLineup('h') },
          idx: { away:0, home:0 },
          pitchLog: []
        };
        
        sync();
        document.getElementById('setupView').style.display='none';
        document.getElementById('gameView').style.display='block';
      };
    });

    // === ë©”ì¸ ë¡œì§ ===
    
    // 1. íˆ¬êµ¬ ì¹´ìš´íŠ¸ (ë¡œê·¸ ì—†ì´ ìƒíƒœë§Œ ë³€ê²½)
    window.addBallCount = (type) => {
      if(type==='b') {
        game.bso.b++; game.pitchLog.push('ë³¼');
        if(game.bso.b>=4) openScenario('4ball', 'bb'); // 4ë³¼ì´ë©´ ìë™ íŒì—…
      } else if(type==='s') {
        game.bso.s++; 
        if(game.bso.s < 3) game.pitchLog.push('ìŠ¤íŠ¸ë¼ì´í¬');
        if(game.bso.s>=3) openScenario('k', 'so'); // 3ìŠ¤íŠ¸ë©´ ìë™ íŒì—…
      } else if(type==='f') {
        if(game.bso.s<2) game.bso.s++;
        game.pitchLog.push('íŒŒìš¸');
      }
      sync();
    };
    
    window.resetBSO = () => { game.bso = {b:0, s:0, o:game.bso.o}; game.pitchLog=[]; sync(); };

    // 2. ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë‹¬ ì—´ê¸°
    window.openScenario = (type, detail) => {
      const modal = document.getElementById('scenarioModal');
      modal.style.display = 'flex';
      
      // ì´ˆê¸°ê°’ ì„¸íŒ… (AI ì¶”ì¸¡ ë¡œì§ ëŒ€ì‹  ê¸°ë³¸ê°’ë§Œ)
      tempScenario = { type, detail, runs: 0, runners: [false,false,false], loc: '' };
      
      document.getElementById('smTitle').textContent = 
         (type==='hit' ? 'ì•ˆíƒ€ ê²°ê³¼ ì…ë ¥' : (type==='out' ? 'ì•„ì›ƒ ê²°ê³¼ ì…ë ¥' : 'ìƒí™© ì…ë ¥'));
         
      // ì•ˆíƒ€ë©´ ë°©í–¥ ì„ íƒ ë³´ì´ê¸°
      document.getElementById('hitLocBox').style.display = (type==='hit' || type==='err') ? 'flex' : 'none';
      
      // í™ˆëŸ°ì´ë©´ ìë™ ë“ì  ê³„ì‚° (ê¸°ì¡´ ì£¼ì + 1)
      if(detail === 4) { // í™ˆëŸ°
         let r = 1;
         if(game.runner.b1) r++; if(game.runner.b2) r++; if(game.runner.b3) r++;
         tempScenario.runs = r;
         // í™ˆëŸ°ì´ë©´ ì£¼ì ì‹¹ ë¹„ì›€
         tempScenario.runners = [false, false, false];
      } else if (type === '4ball') {
         // ë³¼ë„·ì€ ë³´í†µ ë°€ì–´ë‚´ê¸° (ìë™ ê³„ì‚° ì‚´ì§ ë„ì™€ì¤Œ)
         // í•˜ì§€ë§Œ ê´€ë¦¬ìê°€ ìˆ˜ì • ê°€ëŠ¥í•˜ê²Œ
         let r1=game.runner.b1, r2=game.runner.b2, r3=game.runner.b3;
         if(r1){ if(r2){ if(r3){ tempScenario.runs=1; } else r3=true; } else r2=true; } else r1=true;
         tempScenario.runners = [r1, r2, r3];
      } else {
         // ë‚˜ë¨¸ì§€ëŠ” í˜„ì¬ ì£¼ì ìƒíƒœ ê·¸ëŒ€ë¡œ ê°€ì ¸ì˜´ (ê´€ë¦¬ìê°€ ì§ì ‘ ì˜®ê¸°ë¼ê³ )
         tempScenario.runners = [game.runner.b1, game.runner.b2, game.runner.b3];
      }
      
      updateModalUI();
    };

    // ëª¨ë‹¬ UI ê°±ì‹ 
    function updateModalUI() {
      document.getElementById('scoreInput').textContent = tempScenario.runs;
      document.getElementById('chk1').className = 'base-chk bc-1 ' + (tempScenario.runners[0]?'checked':'');
      document.getElementById('chk2').className = 'base-chk bc-2 ' + (tempScenario.runners[1]?'checked':'');
      document.getElementById('chk3').className = 'base-chk bc-3 ' + (tempScenario.runners[2]?'checked':'');
    }

    // ëª¨ë‹¬ ì¡°ì‘ í•¨ìˆ˜ë“¤
    window.toggleBase = (base) => {
      tempScenario.runners[base-1] = !tempScenario.runners[base-1];
      updateModalUI();
    };
    window.adjScore = (n) => {
      tempScenario.runs += n;
      if(tempScenario.runs < 0) tempScenario.runs = 0;
      updateModalUI();
    };
    window.selLoc = (btn, loc) => {
      document.querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('selected'));
      btn.classList.add('selected');
      tempScenario.loc = loc;
    };
    window.closeScenario = () => document.getElementById('scenarioModal').style.display='none';

    // 3. â˜… ìµœì¢… ì „ì†¡ (Submit Scenario)
    window.submitScenario = () => {
      // 1. ë°ì´í„° ë°˜ì˜
      const atk = game.top ? 'away' : 'home';
      const batter = game.lineups[atk][game.idx[atk]];
      const type = tempScenario.type;
      
      // ìŠ¤íƒ¯ ì—…ë°ì´íŠ¸
      batter.pa++; // íƒ€ì„
      if(type !== '4ball' && type !== 'sac') batter.ab++; // íƒ€ìˆ˜ (ë³¼ë„·/í¬ìƒíƒ€ ì œì™¸)
      if(type === 'hit' || type === 'hr') batter.h++; // ì•ˆíƒ€
      if(type === '4ball') batter.bb++; // 4ì‚¬êµ¬
      if(type === 'k') batter.k++; // ì‚¼ì§„
      
      batter.rbi += tempScenario.runs; // íƒ€ì 
      if(tempScenario.runs > 0) {
         // ë³¸ì¸ ë“ì  ì—¬ë¶€? (ì´ê±´ ë³µì¡í•´ì„œ íŒ€ ë“ì ìœ¼ë¡œ í‰ì¹¨, í•„ìš”í•˜ë©´ ë‚˜ì¤‘ì— ì¶”ê°€)
         if(game.top) game.score.away += tempScenario.runs;
         else game.score.home += tempScenario.runs;
      }

      // ì£¼ì ìƒíƒœ ì—…ë°ì´íŠ¸ (ê´€ë¦¬ìê°€ ì„¸íŒ…í•œ ê·¸ëŒ€ë¡œ)
      game.runner.b1 = tempScenario.runners[0];
      game.runner.b2 = tempScenario.runners[1];
      game.runner.b3 = tempScenario.runners[2];

      // ì•„ì›ƒ ì¹´ìš´íŠ¸ ì²˜ë¦¬
      if(type === 'out' || type === 'k') {
         game.bso.o++;
      }
      
      // ë¡œê·¸ ë©”ì‹œì§€ ìƒì„±
      let resultText = "";
      if(type==='hit') resultText = `${tempScenario.loc} ì•ˆíƒ€`;
      else if(tempScenario.detail === 2) resultText = `${tempScenario.loc} 2ë£¨íƒ€`;
      else if(tempScenario.detail === 3) resultText = `${tempScenario.loc} 3ë£¨íƒ€`;
      else if(tempScenario.detail === 4) resultText = "í™ˆëŸ°!!!";
      else if(type==='k') resultText = "ì‚¼ì§„ ì•„ì›ƒ";
      else if(type==='4ball') resultText = "ì‚¬ì‚¬êµ¬ ì¶œë£¨";
      else if(type==='out') resultText = "ë²”íƒ€ ì•„ì›ƒ";
      else resultText = "í”Œë ˆì´ ì¢…ë£Œ";
      
      if(tempScenario.runs > 0) resultText += ` (+${tempScenario.runs}ì )`;

      const pitchHistory = game.pitchLog.length > 0 ? game.pitchLog.join('-') + ' â–¶ ' : '';
      const fullLog = `[${game.idx[atk]+1}ë²ˆ ${batter.name}] ${pitchHistory}${resultText}`;
      
      log(fullLog);

      // ë‹¤ìŒ íƒ€ì / ê³µìˆ˜êµëŒ€
      if(game.bso.o >= 3) {
         alert("3ì•„ì›ƒ! ê³µìˆ˜êµëŒ€");
         changeInning();
      } else {
         game.idx[atk] = (game.idx[atk] + 1) % 9;
         game.bso.b = 0; game.bso.s = 0; game.pitchLog = [];
      }

      sync();
      closeScenario();
    };

    function changeInning() {
      // ê³µìˆ˜ êµëŒ€
      let innNum = parseInt(game.inn);
      if(game.top) {
         game.inn = innNum + 'íšŒë§';
         game.top = false;
      } else {
         game.inn = (innNum + 1) + 'íšŒì´ˆ';
         game.top = true;
      }
      // ì´ˆê¸°í™”
      game.bso = { b:0, s:0, o:0 };
      game.runner = { b1:false, b2:false, b3:false };
      game.pitchLog = [];
      log(`=== ${game.inn} ì‹œì‘ ===`);
    }

    // === ìœ í‹¸ë¦¬í‹° ===
    async function sync() { await update(ref(db, 'status'), game); render(); }
    function log(msg) { push(ref(db, 'logs'), { text: msg, time: new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}), notice: false }); }
    
    // ê²½ê¸° ì¢…ë£Œ (JSON ìƒì„±)
    window.endGame = () => {
       const res = {
          date: new Date().toLocaleDateString(),
          opponent: game.teams.home === 'TAURUS' ? game.teams.away : game.teams.home,
          score: `${game.score.away}:${game.score.home}`,
          result: 'ì¢…ë£Œ'
       };
       alert("ê²½ê¸° ì¢…ë£Œ! ì•„ë˜ ë‚´ìš©ì„ schedule.jsonì— ë°˜ì˜í•˜ì„¸ìš”:\n\n" + JSON.stringify(res));
    };

    // ë Œë”ë§
    function render() {
       document.getElementById('d_away').textContent = game.teams.away;
       document.getElementById('d_home').textContent = game.teams.home;
       document.getElementById('s_away').textContent = game.score.away;
       document.getElementById('s_home').textContent = game.score.home;
       document.getElementById('d_inn').textContent = game.inn;
       
       document.getElementById('cnt_b').textContent = game.bso.b;
       document.getElementById('cnt_s').textContent = game.bso.s;
       document.getElementById('cnt_o').textContent = game.bso.o;
       
       const atk = game.top ? 'away' : 'home';
       const batter = game.lineups[atk][game.idx[atk]];
       document.getElementById('cur_bat').textContent = `${game.idx[atk]+1}ë²ˆ ${batter.name}`;
       document.getElementById('cur_stat').textContent = `${batter.h}ì•ˆíƒ€ / ${batter.rbi}íƒ€ì `;
    }
    
    // DB ë³µêµ¬
    onValue(ref(db, 'status'), (snap) => {
       const d = snap.val();
       if(d) {
          game = d;
          if(!game.pitchLog) game.pitchLog=[];
          render();
          document.getElementById('setupView').style.display='none';
          document.getElementById('gameView').style.display='block';
       }
    });
  </script>
</body>
</html>