<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAURUS ADMIN (Logic Fix)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* íˆ¬êµ¬ ë²„íŠ¼ ë””ìì¸ */
    .pitch-pad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px; }
    .pitch-btn { padding: 12px 4px; border-radius: 8px; font-weight: bold; border: 1px solid #ccc; cursor: pointer; }
    .pb-s { background: #fff59d; color: #f57f17; }
    .pb-b { background: #e0f2f1; color: #00695c; }
    .pb-f { background: #eceff1; color: #546e7a; }
    /* ì •ë³´ íŒ¨ë„ */
    .info-panel { background: #222; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }
    .pitch-log-preview { color: #ffff00; font-weight: bold; margin-top: 5px; font-size: 12px; min-height: 18px; }
    /* ê¸°íƒ€ ë²„íŠ¼ */
    .sub-controls { display: flex; gap: 5px; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }
    .sub-btn { flex: 1; padding: 8px; background: #555; color: #fff; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
    /* ì„¤ì • ë ˆì´ì•„ì›ƒ */
    .team-col { flex: 1; min-width: 140px; }
    .setup-cols { display: flex; gap: 10px; margin-top: 10px; }
    /* ê²½ê¸° ì„ íƒ */
    #matchListArea { margin-bottom: 20px; }
    .match-select-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .match-select-card:hover { background: #e3f2fd; border-color: #2196f3; }
    .m-btn { background: #2196f3; color: #fff; padding: 5px 10px; border-radius: 15px; border: none; font-size: 12px; }
    .skip-btn { width: 100%; padding: 10px; background: #eee; border: none; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body style="background:#f0f0f0;">

  <div id="loginLayer" class="admin-login-overlay">
    <h2>âš¾ TAURUS PRO</h2>
    <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:12px; margin:10px; text-align:center;">
    <button id="loginBtn" style="padding:10px 30px; font-weight:bold;">ENTER</button>
  </div>

  <main id="adminPanel" class="admin-panel">
    <div id="selectMatchSection" class="setup-box">
      <h3>ğŸ“… ê²½ê¸° ì„ íƒ</h3>
      <div id="matchListArea"><p style="text-align:center;">ìŠ¤ì¼€ì¤„ ë¡œë”©ì¤‘...</p></div>
      <button class="skip-btn" id="skipMatchBtn">ì§ì ‘ ì…ë ¥í•˜ê¸°</button>
    </div>

    <div id="setupSection" class="setup-box" style="display:none;">
      <h3>ğŸ› ï¸ ë¼ì¸ì—… ì„¤ì •</h3>
      <p id="selectedMatchInfo" style="color:#00695c; font-weight:bold; font-size:12px; margin-bottom:5px;"></p>
      <div style="margin-bottom:10px; font-size:14px;">
        <label><input type="radio" name="homeAway" value="away" id="radioAway" checked> <b>íƒ€ìš°ë£¨ìŠ¤ ì›ì • (ì„ ê³µ)</b></label>
        <label><input type="radio" name="homeAway" value="home" id="radioHome" style="margin-left:15px;"> <b>íƒ€ìš°ë£¨ìŠ¤ í™ˆ (í›„ê³µ)</b></label>
      </div>
      <div class="setup-cols">
        <div class="team-col">
          <input type="text" id="setupAwayName" placeholder="ì›ì •íŒ€" value="TAURUS" style="width:100%; text-align:center; font-weight:bold; margin-bottom:5px;">
          <input type="text" id="startPitcherAway" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; margin-bottom:5px; background:#e3f2fd;">
          <div id="awayLineupGrid"></div>
        </div>
        <div class="team-col">
          <input type="text" id="setupHomeName" placeholder="í™ˆíŒ€" style="width:100%; text-align:center; font-weight:bold; margin-bottom:5px;">
          <input type="text" id="startPitcherHome" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; margin-bottom:5px; background:#e3f2fd;">
          <div id="homeLineupGrid"></div>
        </div>
      </div>
      <button id="startGameBtn" class="send-btn" style="background:#333; margin-top:15px;">ê²½ê¸° ì‹œì‘ (PLAY BALL)</button>
    </div>

    <div id="gameSection" style="display:none;">
      <div class="live-scoreboard" style="margin:0 0 10px 0; border-radius:12px; padding:10px;">
        <div class="live-score-box">
          <div class="live-team">AWAY<br><span id="dispAway" style="font-size:14px;"></span></div>
          <div class="live-score"><span id="scAway">0</span>:<span id="scHome">0</span></div>
          <div class="live-team">HOME<br><span id="dispHome" style="font-size:14px;"></span></div>
        </div>
        <div style="margin-top:5px;">
           <button id="btnPrevInn">â—€</button>
           <span id="inningVal" style="margin:0 10px; font-weight:bold;">1íšŒì´ˆ</span>
           <button id="btnNextInn">â–¶</button>
        </div>
      </div>

      <div class="info-panel">
        <div><span id="currentBatterInfo" style="color:#ffeb3b; font-weight:bold; font-size:15px;">íƒ€ì„: -</span></div>
        <div style="font-size:12px; color:#ccc;">ë§ˆìš´ë“œ: <span id="currentPitcherName">-</span> (íˆ¬êµ¬ìˆ˜: <span id="pitchCountTotal">0</span>)</div>
        <div class="pitch-log-preview" id="pitchLogPreview">í˜„ì¬ íƒ€ì„: ëŒ€ê¸° ì¤‘...</div>
      </div>

      <div class="control-group" style="padding:10px;">
        <div class="runner-control" style="height:100px;">
           <div id="base3" class="base-plate bp-3" data-base="b3" style="top:35px;"><span>3</span></div>
           <div id="base2" class="base-plate bp-2" data-base="b2" style="top:5px;"><span>2</span></div>
           <div id="base1" class="base-plate bp-1" data-base="b1" style="top:35px;"><span>1</span></div>
        </div>
        <div style="text-align:center; font-weight:bold; margin-top:5px; font-size:18px;">
           <span style="color:green">B</span> <span id="dispB">0</span> &nbsp;
           <span style="color:#fbc02d">S</span> <span id="dispS">0</span> &nbsp;
           <span style="color:red">O</span> <span id="dispO">0</span>
        </div>
      </div>

      <div class="control-group">
        <h4 style="margin:0 0 5px; font-size:13px; color:#555;">âš¾ 1êµ¬ 1êµ¬ ì…ë ¥ (Live Statusë§Œ ê°±ì‹ )</h4>
        <div class="pitch-pad">
          <button class="pitch-btn pb-s" data-pitch="look">ë£¨í‚¹S</button>
          <button class="pitch-btn pb-s" data-pitch="swing">í—›ìŠ¤ìœ™</button>
          <button class="pitch-btn pb-f" data-pitch="foul">íŒŒìš¸</button>
          <button class="pitch-btn pb-b" data-pitch="ball">ë³¼</button>
        </div>
        
        <h4 style="margin:10px 0 5px; font-size:13px; color:#555;">ğŸ’¥ ìµœì¢… ê²°ê³¼ (ë¡œê·¸ ì „ì†¡)</h4>
        <div class="action-pad" style="grid-template-columns: repeat(4, 1fr);">
          <button class="act-btn act-hit" data-act="1b">ì•ˆíƒ€</button>
          <button class="act-btn act-hit" data-act="2b">2ë£¨íƒ€</button>
          <button class="act-btn act-hit" data-act="3b">3ë£¨íƒ€</button>
          <button class="act-btn act-hit" data-act="hr">í™ˆëŸ°</button>
          <button class="act-btn act-out" data-act="gnd_menu">ë•…ë³¼</button>
          <button class="act-btn act-out" data-act="fly_menu">ëœ¬ê³µ</button>
          <button class="act-btn act-out" data-act="k_menu">ì‚¼ì§„</button>
          <button class="act-btn act-out" data-act="fc_menu">ì•¼ì„ </button>
          <button class="act-btn act-base" data-act="bb_menu">ì‚¬ì‚¬êµ¬</button>
          <button class="act-btn act-adv" data-act="err_menu">ì‹¤ì±…</button>
          <button class="act-btn" style="background:#555; color:#fff;" data-act="inf_hit">ë‚´ì•¼ì•ˆíƒ€</button>
        </div>

        <div class="sub-controls">
           <button class="sub-btn" onclick="window.changeCurrentBatter()">ğŸ”„ ëŒ€íƒ€</button>
           <button class="sub-btn" onclick="window.changeCurrentPitcher()">âš¾ íˆ¬ìˆ˜êµì²´</button>
           <button class="sub-btn" onclick="window.sendManualTextFn()">ğŸ’¬ í…ìŠ¤íŠ¸</button>
        </div>
      </div>

      <div style="margin-top:10px; display:none;" id="manualInputBox">
        <textarea id="comment" rows="2" class="control-input" placeholder="ë‚´ìš©..."></textarea>
      </div>
      <div style="margin-top:20px; text-align:center;">
         <button id="resetGameBtn" style="background:#ddd; color:#333; border:none; padding:6px; font-size:11px;">âš ï¸ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </main>

  <div id="actionModal" class="action-modal" style="display:none;">
     <div class="am-content"><h3 id="amTitle">ìƒì„¸</h3><div id="amButtons" class="am-btn-group"></div><button id="closeModalBtn" style="margin-top:15px; width:100%; padding:10px;">ë‹«ê¸°</button></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMVkogwvzoQon3lo0_hiVewfoXxmvbYMU",
      authDomain: "taurus-cbnu.firebaseapp.com",
      databaseURL: "https://taurus-cbnu-default-rtdb.firebaseio.com",
      projectId: "taurus-cbnu",
      storageBucket: "taurus-cbnu.firebasestorage.app",
      messagingSenderId: "598393475132",
      appId: "1:598393475132:web:b266ef01509e6c20dd7339"
    };

    let app, db;
    try { app = initializeApp(firebaseConfig); db = getDatabase(app); } catch (e) { console.error(e); }

    let gameState = {
        teams: { away: 'TAURUS', home: 'ìƒëŒ€íŒ€' }, inningStr: '1íšŒì´ˆ', isTop: true,
        score: { away: 0, home: 0 }, bso: { b:0, s:0, o:0 }, runners: { b1: null, b2: null, b3: null },
        lineups: { away: [], home: [] }, pitchers: { away: {name:'',total:0,s:0,b:0}, home: {name:'',total:0,s:0,b:0} },
        batIdx: { away: 0, home: 0 }, currentPitchLog: []
    };

    document.addEventListener('DOMContentLoaded', () => {
        createLineupInputs('awayLineupGrid', 'awayP'); createLineupInputs('homeLineupGrid', 'homeP');
        bindEvent('loginBtn', 'click', handleLogin); bindEvent('adminPw', 'keypress', (e)=>{if(e.key==='Enter')handleLogin();});
        bindEvent('startGameBtn', 'click', startGame); bindEvent('skipMatchBtn', 'click', ()=>showSetupScreen());
        bindEvent('btnPrevInn', 'click', ()=>changeInning(-1)); bindEvent('btnNextInn', 'click', ()=>changeInning(1));
        bindEvent('resetGameBtn', 'click', resetGame); bindEvent('closeModalBtn', 'click', closeModal);
        document.querySelectorAll('.pitch-btn').forEach(b=>b.addEventListener('click', (e)=>handlePitch(e.target.dataset.pitch)));
        document.querySelectorAll('.act-btn').forEach(b=>b.addEventListener('click', (e)=>handleAction(e.target.dataset.act)));
        document.querySelectorAll('.base-plate').forEach(b=>b.addEventListener('click', ()=>handleBaseClick(b.dataset.base)));
        loadScheduledMatches();
    });

    async function loadScheduledMatches() {
        const area = document.getElementById('matchListArea');
        try {
            const res = await fetch('schedule.json?t='+Date.now()); if(!res.ok) throw new Error("X");
            const data = await res.json();
            let matches = [];
            Object.keys(data).forEach(y => { if(Array.isArray(data[y])) data[y].forEach(g => { if(g.result==='ì˜ˆì •') matches.push({...g}); }); });
            if(matches.length===0) area.innerHTML = '<p style="text-align:center;">ì˜ˆì • ê²½ê¸° ì—†ìŒ</p>';
            else {
                area.innerHTML = '';
                matches.forEach(m => {
                    const d = document.createElement('div'); d.className='match-select-card';
                    d.innerHTML = `<div><span class="m-id">${m.date} ${m.time}</span><div class="m-vs">vs ${m.opponent}</div></div><button class="m-btn">ì„ íƒ</button>`;
                    d.onclick = () => {
                        const loc = m.location||""; const isHome = (loc.includes('ì²­ì£¼')||loc.includes('ë³¸êµ')||loc.includes('ì²­ì›'));
                        if(isHome) { document.getElementById('radioHome').checked=true; document.getElementById('setupHomeName').value="TAURUS"; document.getElementById('setupAwayName').value=m.opponent; }
                        else { document.getElementById('radioAway').checked=true; document.getElementById('setupAwayName').value="TAURUS"; document.getElementById('setupHomeName').value=m.opponent; }
                        document.getElementById('selectedMatchInfo').textContent=`ì„ íƒ: ${m.date} vs ${m.opponent}`; showSetupScreen();
                    };
                    area.appendChild(d);
                });
            }
        } catch(e) { area.innerHTML = '<p style="text-align:center;">ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹¤íŒ¨</p>'; }
    }

    function showSetupScreen() { document.getElementById('selectMatchSection').style.display='none'; document.getElementById('setupSection').style.display='block'; }
    function createLineupInputs(id, pfix) { const g=document.getElementById(id); if(g) { g.innerHTML=''; for(let i=0;i<9;i++) g.innerHTML+=`<div class="lineup-row" style="margin-bottom:2px;"><span class="pos-badge">${i+1}</span><input type="text" id="${pfix}${i}" style="width:90px; padding:4px;"></div>`; } }
    function bindEvent(id, type, h) { const e=document.getElementById(id); if(e) e.addEventListener(type, h); }
    function handleLogin() { if(document.getElementById('adminPw').value==='taurus') { document.getElementById('loginLayer').style.display='none'; document.getElementById('adminPanel').style.display='block'; } else alert('PW?'); }

    async function startGame() {
        if(!db) return alert("DBì—°ê²° ì‹¤íŒ¨");
        const freshState = {
            teams:{away:'',home:''}, inningStr:'1íšŒì´ˆ', isTop:true, score:{away:0,home:0}, bso:{b:0,s:0,o:0}, runners:{b1:null,b2:null,b3:null},
            lineups:{away:[],home:[]}, pitchers:{away:{name:'',total:0,s:0,b:0}, home:{name:'',total:0,s:0,b:0}}, batIdx:{away:0,home:0}, currentPitchLog:[]
        };
        const isHome = document.querySelector('input[name="homeAway"]:checked').value === 'home';
        freshState.isTop = !isHome; // í™ˆì´ë©´ ë§ê³µê²©(false), ì›ì •ì´ë©´ ì´ˆê³µê²©(true)
        freshState.teams.away = document.getElementById('setupAwayName').value;
        freshState.teams.home = document.getElementById('setupHomeName').value;
        freshState.pitchers.away.name = document.getElementById('startPitcherAway').value;
        freshState.pitchers.home.name = document.getElementById('startPitcherHome').value;
        freshState.lineups.away = readLineupInputs('awayP');
        freshState.lineups.home = readLineupInputs('homeP');
        
        gameState = freshState;
        await set(ref(db, 'status'), gameState);
        document.getElementById('setupSection').style.display='none'; document.getElementById('gameSection').style.display='block'; renderBoard();
    }
    function readLineupInputs(p) { let a=[]; for(let i=0;i<9;i++) a.push({name:document.getElementById(p+i).value||`íƒ€ì${i+1}`, ab:0, h:0, rbi:0, bb:0, k:0}); return a; }

    // === í•µì‹¬: íˆ¬êµ¬ (ë¡œê·¸ ì €ì¥ X, ìƒíƒœë§Œ ì—…ë°ì´íŠ¸) ===
    async function handlePitch(type) {
        if(!gameState.currentPitchLog) gameState.currentPitchLog=[];
        if(!gameState.pitchers) return;
        const def = gameState.isTop?'home':'away';
        const p = gameState.pitchers[def];
        p.total++;
        
        let pitchName = "";
        if(type==='ball') { 
            p.b++; gameState.bso.b++; pitchName="ë³¼"; 
            if(gameState.bso.b>=4) { gameState.currentPitchLog.push(pitchName); processPlay('bb'); return; }
        } else {
            p.s++; 
            if(type!=='foul' || gameState.bso.s<2) gameState.bso.s++;
            if(type==='look') pitchName="ìŠ¤íŠ¸ë¼ì´í¬";
            else if(type==='swing') pitchName="í—›ìŠ¤ìœ™";
            else if(type==='foul') pitchName="íŒŒìš¸";
            
            if(gameState.bso.s>=3) { gameState.currentPitchLog.push(pitchName); processPlay(type==='look'?'k_look':'k_swing'); return; }
        }
        gameState.currentPitchLog.push(pitchName);
        await syncAll(); renderBoard();
    }

    function handleAction(act) { if(act.includes('_menu')) openModal(act); else processPlay(act); }

    // === í•µì‹¬: ê²°ê³¼ ì²˜ë¦¬ (ì—¬ê¸°ì„œë§Œ ë¡œê·¸ ì „ì†¡) ===
    async function processPlay(code) {
        if(!gameState.currentPitchLog) gameState.currentPitchLog=[];
        
        const atk = gameState.isTop?'away':'home';
        const def = gameState.isTop?'home':'away';
        const batter = gameState.lineups[atk][gameState.batIdx[atk]];
        const pitcher = gameState.pitchers[def];

        // íƒ€ê²©ì´ë©´ íˆ¬êµ¬ìˆ˜ ì¶”ê°€
        if(!['bb','k_look','k_swing','not_out','hbp'].includes(code)) {
            pitcher.total++; pitcher.s++; gameState.currentPitchLog.push('íƒ€ê²©');
        }

        // ê²°ê³¼ ë¬¸ìì—´ ìƒì„±
        let resultTxt = "";
        if(code==='1b') { batter.ab++; batter.h++; resultTxt='ì¢Œì „ ì•ˆíƒ€'; advanceRunners(1); gameState.runners.b1=batter.name; }
        else if(code==='2b') { batter.ab++; batter.h++; resultTxt='2ë£¨íƒ€'; advanceRunners(2); gameState.runners.b2=batter.name; }
        else if(code==='3b') { batter.ab++; batter.h++; resultTxt='3ë£¨íƒ€'; advanceRunners(3); gameState.runners.b3=batter.name; }
        else if(code==='hr') { batter.ab++; batter.h++; batter.rbi++; batter.run++; resultTxt='í™ˆëŸ°!'; advanceRunners(4); }
        else if(code==='inf_hit') { batter.ab++; batter.h++; resultText='ë‚´ì•¼ì•ˆíƒ€'; advanceRunners(1); gameState.runners.b1=batter.name; }
        else if(code==='go') { batter.ab++; resultTxt='ë•…ë³¼ ì•„ì›ƒ'; addOut(); }
        else if(code==='fo') { batter.ab++; resultTxt='ëœ¬ê³µ ì•„ì›ƒ'; addOut(); }
        else if(code==='k_look') { batter.ab++; batter.k++; resultTxt='ë£¨í‚¹ ì‚¼ì§„'; addOut(); }
        else if(code==='k_swing') { batter.ab++; batter.k++; resultText='í—›ìŠ¤ìœ™ ì‚¼ì§„'; addOut(); }
        else if(code==='bb') { batter.bb++; resultTxt='ë³¼ë„· ì¶œë£¨'; pushRunners(); gameState.runners.b1=batter.name; }
        else if(code==='hbp') { batter.bb++; resultTxt='ì‚¬êµ¬ ì¶œë£¨'; pushRunners(); gameState.runners.b1=batter.name; }
        else if(code==='fc_safe') { batter.ab++; resultTxt='ì•¼ì„  ì¶œë£¨'; addOut(); if(gameState.runners.b1)gameState.runners.b1=null; gameState.runners.b1=batter.name; }
        else if(code==='dp') { batter.ab++; resultTxt='ë³‘ì‚´íƒ€'; addOut(); addOut(); if(gameState.runners.b1)gameState.runners.b1=null; }
        else if(code==='error_safe') { batter.ab++; resultTxt='ì‹¤ì±… ì¶œë£¨'; pushRunners(); gameState.runners.b1=batter.name; }

        // â˜… ë¡œê·¸ ì „ì†¡: 1êµ¬ ë³¼, 2êµ¬ ìŠ¤íŠ¸ë¼ì´í¬... -> ê²°ê³¼
        let fullLog = "";
        if(gameState.currentPitchLog.length > 0) {
            fullLog = gameState.currentPitchLog.map((p,i)=>`${i+1}êµ¬ ${p}`).join(', ');
            fullLog += ` â–¶ ${resultTxt}`;
        } else {
            fullLog = resultTxt; // ì´ˆêµ¬ íƒ€ê²© ë“±
        }
        
        const logMsg = `[${gameState.batIdx[atk]+1}ë²ˆ ${batter.name}] ${fullLog}`;
        log(logMsg);

        // ë‹¤ìŒ íƒ€ì ì¤€ë¹„
        if(gameState.bso.o >= 3) {
            alert("3ì•„ì›ƒ! ê³µìˆ˜êµëŒ€");
            changeInning(1);
        } else {
            nextBatter(atk);
            resetCount();
        }
        await syncAll(); renderBoard();
    }

    // ìœ í‹¸
    function advanceRunners(bases) {
        if(!gameState.runners) gameState.runners={b1:null,b2:null,b3:null};
        let r=gameState.runners; let sc=0; const atk=gameState.isTop?'away':'home';
        if(r.b3){r.b3=null;sc++;}
        if(r.b2){if(bases>=2){r.b2=null;sc++;}else{r.b3=r.b2;r.b2=null;}}
        if(r.b1){if(bases>=3){r.b1=null;sc++;}else if(bases===2){r.b3=r.b1;r.b1=null;}else{r.b2=r.b1;r.b1=null;}}
        if(sc>0){addScore(sc); gameState.lineups[atk][gameState.batIdx[atk]].rbi+=sc;}
    }
    function pushRunners(){
        if(!gameState.runners) gameState.runners={b1:null,b2:null,b3:null};
        let r=gameState.runners; const atk=gameState.isTop?'away':'home';
        if(r.b1){if(r.b2){if(r.b3){addScore(1);gameState.lineups[atk][gameState.batIdx[atk]].rbi++;}else r.b3=r.b2;}else r.b2=r.b1;}
    }
    function addOut(){ gameState.bso.o++; } // ì—¬ê¸°ì„œ ë°”ë¡œ ì²´ì¸ì§€ ì•ˆí•¨
    function addScore(n){ if(gameState.isTop)gameState.score.away+=n; else gameState.score.home+=n; }
    function nextBatter(side){ gameState.batIdx[side]=(gameState.batIdx[side]+1)%9; }
    function resetCount(){ gameState.bso.b=0;gameState.bso.s=0;gameState.currentPitchLog=[]; }
    function changeInning(d){
        let n=parseInt(gameState.inningStr); 
        if(gameState.isTop) { gameState.inningStr=`${n}íšŒë§`; gameState.isTop=false; }
        else { gameState.inningStr=`${n+1}íšŒì´ˆ`; gameState.isTop=true; }
        
        // í•´ë‹¹ íŒ€ì˜ íƒ€ìˆœì€ nextBatter ì•ˆì“°ê³  ê·¸ëŒ€ë¡œ ë‘  (ì´ì–´í•˜ê¸°)
        const nextSide = gameState.isTop ? 'away' : 'home';
        // ë‹¤ìŒ ê³µê²©íŒ€ì˜ íƒ€ìˆœì´ ì´ë¯¸ ì €ì¥ë˜ì–´ ìˆìœ¼ë¯€ë¡œ ê±´ë“œë¦¬ì§€ ì•ŠìŒ
        
        gameState.bso={b:0,s:0,o:0}; gameState.runners={b1:null,b2:null,b3:null}; gameState.currentPitchLog=[];
        log(`=== ${gameState.inningStr} ì‹œì‘ ===`);
    }

    // ê¸°íƒ€
    window.changeCurrentBatter=()=>{const s=gameState.isTop?'away':'home';const i=gameState.batIdx[s];const n=prompt('ëŒ€íƒ€:',gameState.lineups[s][i].name);if(n){gameState.lineups[s][i].name=n;log(`[êµì²´] ëŒ€íƒ€ ${n}`);syncAll();renderBoard();}};
    window.changeCurrentPitcher=()=>{const s=gameState.isTop?'home':'away';const n=prompt('íˆ¬ìˆ˜êµì²´:',gameState.pitchers[s].name);if(n){gameState.pitchers[s]={name:n,total:0,s:0,b:0};log(`[êµì²´] íˆ¬ìˆ˜ ${n}`);syncAll();renderBoard();}};
    window.sendManualTextFn=()=>{const t=document.getElementById('comment').value;if(t){log(t);document.getElementById('comment').value='';}};
    window.handleBaseClick=(b)=>{if(!gameState.runners)gameState.runners={b1:null,b2:null,b3:null}; if(gameState.runners[b]){if(confirm('ì‚­ì œ?')){gameState.runners[b]=null;syncAll();renderBoard();}}else{const n=prompt('ì£¼ìëª…:');if(n){gameState.runners[b]=n;syncAll();renderBoard();}}};
    function openModal(act) { const m=document.getElementById('actionModal'); const b=document.getElementById('amButtons'); b.innerHTML=''; m.style.display='flex'; let btns=[]; if(act==='gnd_menu')btns=[{txt:'ë•…ë³¼',code:'go'},{txt:'ì•¼ì„ ',code:'fc_safe'},{txt:'ë³‘ì‚´',code:'dp'}]; else if(act==='fly_menu')btns=[{txt:'ëœ¬ê³µ',code:'fo'}]; else if(act==='k_menu')btns=[{txt:'í—›ìŠ¤ìœ™K',code:'k_swing'},{txt:'ë£¨í‚¹K',code:'k_look'}]; else if(act==='bb_menu')btns=[{txt:'ë³¼ë„·',code:'bb'},{txt:'ëª¸ë§ê³µ',code:'hbp'}]; else if(act==='err_menu')btns=[{txt:'ì‹¤ì±…',code:'error_safe'}]; btns.forEach(i=>{const btn=document.createElement('button');btn.className='am-btn';btn.textContent=i.txt;btn.onclick=()=>{processPlay(i.code);closeModal();};b.appendChild(btn);}); }
    function closeModal() { document.getElementById('actionModal').style.display='none'; }
    async function syncAll() { if(db) await update(ref(db, 'status'), gameState); }
    function log(msg) { if(db) push(ref(db, 'logs'), { text: msg, time: new Date().toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'}), notice: false }); }

    function renderBoard() {
        const g=gameState; if(!g.lineups)return;
        document.getElementById('scAway').textContent=g.score.away; document.getElementById('scHome').textContent=g.score.home;
        document.getElementById('dispAway').textContent=g.teams.away; document.getElementById('dispHome').textContent=g.teams.home;
        document.getElementById('inningVal').textContent=g.inningStr;
        document.getElementById('dispB').textContent=g.bso.b; document.getElementById('dispS').textContent=g.bso.s; document.getElementById('dispO').textContent=g.bso.o;
        ['b1','b2','b3'].forEach(k=>{const el=document.querySelector(`[data-base="${k}"]`); if(el){if(g.runners&&g.runners[k]){el.classList.add('active');el.title=g.runners[k];}else{el.classList.remove('active');el.title='';}}});
        
        const atk=g.isTop?'away':'home'; const bat=g.lineups[atk][g.batIdx[atk]];
        document.getElementById('currentBatterInfo').textContent=`íƒ€ì„: ${g.batIdx[atk]+1}ë²ˆ ${bat.name}`;
        document.getElementById('currentPitcherName').textContent=g.pitchers[g.isTop?'home':'away'].name;
        document.getElementById('pitchCountTotal').textContent=g.pitchers[g.isTop?'home':'away'].total;
        
        // íˆ¬êµ¬ ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°
        if(g.currentPitchLog && g.currentPitchLog.length>0) {
            document.getElementById('pitchLogPreview').textContent = g.currentPitchLog.join(' - ');
        } else {
            document.getElementById('pitchLogPreview').textContent = "ì´ˆêµ¬ ëŒ€ê¸° ì¤‘...";
        }
    }
    
    onValue(ref(db, 'status'), (snap) => {
        const d=snap.val(); if(d){ gameState=d; if(!gameState.runners)gameState.runners={b1:null,b2:null,b3:null}; renderBoard(); }
    });
    function resetGame(){if(confirm("ì´ˆê¸°í™”?")){set(ref(db,'status'),null);set(ref(db,'logs'),null);location.reload();}}
  </script>
</body>
</html>