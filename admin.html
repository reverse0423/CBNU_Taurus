<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAURUS PRO RECORDER</title>
  <link rel="stylesheet" href="style.css">
  <style>
    .pitch-pad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px; }
    .pitch-btn { padding: 12px 4px; border-radius: 8px; font-weight: bold; border: 1px solid #ccc; cursor: pointer; }
    .pb-s { background: #fff59d; color: #f57f17; }
    .pb-b { background: #e0f2f1; color: #00695c; }
    .pb-f { background: #eceff1; color: #546e7a; }
    .info-panel { background: #222; color: #fff; padding: 10px; border-radius: 8px; margin-bottom: 10px; font-size: 13px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 4px; }
    .pitcher-stat { color: #4fc3f7; font-weight: bold; }
    .sub-controls { display: flex; gap: 5px; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }
    .sub-btn { flex: 1; padding: 8px; background: #555; color: #fff; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .team-col { flex: 1; min-width: 140px; }
    .setup-cols { display: flex; gap: 10px; margin-top: 10px; }
    
    /* ë¶ˆëŸ¬ì˜¤ê¸° ë²„íŠ¼ ìŠ¤íƒ€ì¼ */
    #loadScheduleBtn {
      width: 100%; background: #e0f7fa; color: #006064; border: 1px solid #b2ebf2;
      padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; margin-bottom: 15px;
    }
    #loadScheduleBtn:hover { background: #b2ebf2; }
  </style>
</head>
<body style="background:#f0f0f0;">

  <div id="loginLayer" class="admin-login-overlay">
    <h2>âš¾ TAURUS PRO</h2>
    <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ (taurus)" style="padding:12px; margin:10px; width:200px; text-align:center;">
    <button id="loginBtn" style="padding:10px 30px; font-weight:bold;">ENTER</button>
  </div>

  <main id="adminPanel" class="admin-panel">
    <div id="setupSection" class="setup-box">
      <h3>ğŸ› ï¸ ê²½ê¸° ì„¤ì • (Lineup)</h3>
      
      <button id="loadScheduleBtn">ğŸ“… ì˜¤ëŠ˜ ìŠ¤ì¼€ì¤„ ë¶ˆëŸ¬ì˜¤ê¸° (Click)</button>

      <div style="margin-bottom:10px; font-size:14px;">
        <label><input type="radio" name="homeAway" value="away" id="radioAway" checked> <b>íƒ€ìš°ë£¨ìŠ¤ ì›ì • (ì„ ê³µ)</b></label>
        <label><input type="radio" name="homeAway" value="home" id="radioHome" style="margin-left:15px;"> <b>íƒ€ìš°ë£¨ìŠ¤ í™ˆ (í›„ê³µ)</b></label>
      </div>
      <div class="setup-cols">
        <div class="team-col">
          <input type="text" id="setupAwayName" placeholder="ì›ì •íŒ€ëª…" value="TAURUS" style="width:100%; font-weight:bold; text-align:center; margin-bottom:5px;">
          <input type="text" id="startPitcherAway" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; margin-bottom:5px; background:#e3f2fd;">
          <div id="awayLineupGrid"></div>
        </div>
        <div class="team-col">
          <input type="text" id="setupHomeName" placeholder="í™ˆíŒ€ëª…" style="width:100%; font-weight:bold; text-align:center; margin-bottom:5px;">
          <input type="text" id="startPitcherHome" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; margin-bottom:5px; background:#e3f2fd;">
          <div id="homeLineupGrid"></div>
        </div>
      </div>
      <button id="startGameBtn" class="send-btn" style="background:#333; margin-top:15px;">PLAY BALL!</button>
    </div>

    <div id="gameSection" style="display:none;">
      <div class="live-scoreboard" style="margin:0 0 10px 0; border-radius:12px; padding:10px;">
        <div class="live-score-box">
          <div class="live-team">AWAY<br><span id="dispAway" style="font-size:14px;"></span></div>
          <div class="live-score"><span id="scAway">0</span>:<span id="scHome">0</span></div>
          <div class="live-team">HOME<br><span id="dispHome" style="font-size:14px;"></span></div>
        </div>
        <div style="margin-top:5px;">
           <button id="btnPrevInn">â—€</button>
           <span id="inningVal" style="margin:0 10px; font-weight:bold;">1íšŒì´ˆ</span>
           <button id="btnNextInn">â–¶</button>
        </div>
      </div>

      <div class="info-panel">
        <div class="info-row" style="border-bottom:1px solid #444; padding-bottom:4px; margin-bottom:6px;">
          <span id="currentBatterInfo" style="color:#ffeb3b; font-weight:bold;">íƒ€ì„: -</span>
          <span id="currentBatterStat" style="color:#aaa;"></span>
        </div>
        <div class="info-row">
          <span>ë§ˆìš´ë“œ: <span id="currentPitcherName">-</span></span>
          <span class="pitcher-stat">íˆ¬êµ¬ìˆ˜: <span id="pitchCountTotal">0</span> (S:<span id="pitchCountS">0</span> B:<span id="pitchCountB">0</span>)</span>
        </div>
      </div>

      <div class="control-group" style="padding:10px;">
        <div class="runner-control" style="height:100px;">
           <div id="base3" class="base-plate bp-3" data-base="b3" style="top:35px;"><span>3</span></div>
           <div id="base2" class="base-plate bp-2" data-base="b2" style="top:5px;"><span>2</span></div>
           <div id="base1" class="base-plate bp-1" data-base="b1" style="top:35px;"><span>1</span></div>
        </div>
        <div style="text-align:center; font-weight:bold; margin-top:5px; font-size:18px;">
           <span style="color:green">B</span> <span id="dispB">0</span> &nbsp;
           <span style="color:#fbc02d">S</span> <span id="dispS">0</span> &nbsp;
           <span style="color:red">O</span> <span id="dispO">0</span>
        </div>
      </div>

      <div class="control-group">
        <h4 style="margin:0 0 5px; font-size:13px; color:#555;">âš¾ íˆ¬êµ¬ ê¸°ë¡</h4>
        <div class="pitch-pad">
          <button class="pitch-btn pb-s" data-pitch="look">ë£¨í‚¹S</button>
          <button class="pitch-btn pb-s" data-pitch="swing">í—›ìŠ¤ìœ™</button>
          <button class="pitch-btn pb-f" data-pitch="foul">íŒŒìš¸</button>
          <button class="pitch-btn pb-b" data-pitch="ball">ë³¼</button>
        </div>
        <h4 style="margin:10px 0 5px; font-size:13px; color:#555;">ğŸ’¥ íƒ€ê²© ê²°ê³¼</h4>
        <div class="action-pad" style="grid-template-columns: repeat(4, 1fr);">
          <button class="act-btn act-hit" data-act="1b">ì•ˆíƒ€</button>
          <button class="act-btn act-hit" data-act="2b">2ë£¨íƒ€</button>
          <button class="act-btn act-hit" data-act="3b">3ë£¨íƒ€</button>
          <button class="act-btn act-hit" data-act="hr">í™ˆëŸ°</button>
          <button class="act-btn act-out" data-act="gnd_menu">ë•…ë³¼</button>
          <button class="act-btn act-out" data-act="fly_menu">ëœ¬ê³µ</button>
          <button class="act-btn act-out" data-act="k_menu">ì‚¼ì§„</button>
          <button class="act-btn act-out" data-act="fc_menu">ì•¼ì„ </button>
          <button class="act-btn act-base" data-act="bb_menu">ì‚¬ì‚¬êµ¬</button>
          <button class="act-btn act-adv" data-act="err_menu">ì‹¤ì±…</button>
          <button class="act-btn" style="background:#555; color:#fff;" data-act="inf_hit">ë‚´ì•¼ì•ˆíƒ€</button>
        </div>
        <div class="sub-controls">
           <button class="sub-btn" onclick="window.changeCurrentBatter()">ğŸ”„ ëŒ€íƒ€ êµì²´</button>
           <button class="sub-btn" onclick="window.changeCurrentPitcher()">âš¾ íˆ¬ìˆ˜ êµì²´</button>
           <button class="sub-btn" onclick="window.sendManualTextFn()">ğŸ’¬ í…ìŠ¤íŠ¸ë§Œ ì „ì†¡</button>
        </div>
      </div>

      <div style="margin-top:10px; display:none;" id="manualInputBox">
        <textarea id="comment" rows="2" class="control-input" placeholder="ë‚´ìš© ì…ë ¥..."></textarea>
      </div>
      <div style="margin-top:20px; text-align:center;">
         <button id="resetGameBtn" style="background:#ddd; color:#333; border:none; padding:6px; border-radius:4px; font-size:11px;">âš ï¸ ê²½ê¸° ì´ˆê¸°í™”</button>
      </div>
    </div>
  </main>

  <div id="actionModal" class="action-modal" style="display:none;">
     <div class="am-content">
        <h3 id="amTitle">ìƒì„¸ ì„ íƒ</h3>
        <div id="amButtons" class="am-btn-group"></div>
        <button id="closeModalBtn" style="margin-top:15px; width:100%; padding:10px;">ë‹«ê¸°</button>
     </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMVkogwvzoQon3lo0_hiVewfoXxmvbYMU",
      authDomain: "taurus-cbnu.firebaseapp.com",
      databaseURL: "https://taurus-cbnu-default-rtdb.firebaseio.com",
      projectId: "taurus-cbnu",
      storageBucket: "taurus-cbnu.firebasestorage.app",
      messagingSenderId: "598393475132",
      appId: "1:598393475132:web:b266ef01509e6c20dd7339"
    };

    let app, db;
    try { app = initializeApp(firebaseConfig); db = getDatabase(app); } catch (e) { console.error(e); }

    let gameState = {
        teams: { away: 'TAURUS', home: 'ìƒëŒ€íŒ€' },
        inningStr: '1íšŒì´ˆ', isTop: true,
        score: { away: 0, home: 0 },
        bso: { b:0, s:0, o:0 },
        runners: { b1: null, b2: null, b3: null },
        lineups: { away: [], home: [] },
        pitchers: { away: {name:'',total:0,s:0,b:0}, home: {name:'',total:0,s:0,b:0} },
        batIdx: { away: 0, home: 0 },
        currentPitchLog: []
    };

    document.addEventListener('DOMContentLoaded', () => {
        createLineupInputs('awayLineupGrid', 'awayP');
        createLineupInputs('homeLineupGrid', 'homeP');
        bindEvent('loginBtn', 'click', handleLogin);
        bindEvent('adminPw', 'keypress', (e) => { if(e.key==='Enter') handleLogin(); });
        bindEvent('startGameBtn', 'click', startGame);
        bindEvent('btnPrevInn', 'click', () => changeInning(-1));
        bindEvent('btnNextInn', 'click', () => changeInning(1));
        bindEvent('resetGameBtn', 'click', resetGame);
        bindEvent('closeModalBtn', 'click', closeModal);
        bindEvent('loadScheduleBtn', 'click', autoFillFromSchedule); // ë²„íŠ¼ ì—°ê²°

        document.querySelectorAll('.pitch-btn').forEach(btn => btn.addEventListener('click', (e) => handlePitch(e.target.dataset.pitch)));
        document.querySelectorAll('.act-btn').forEach(btn => btn.addEventListener('click', (e) => handleAction(e.target.dataset.act)));
        document.querySelectorAll('.base-plate').forEach(plate => plate.addEventListener('click', () => handleBaseClick(plate.dataset.base)));
    });

    // â˜… ìŠ¤ì¼€ì¤„ ë¶ˆëŸ¬ì˜¤ê¸° ë¡œì§ (ë²„íŠ¼ í´ë¦­ ì‹œ ì‹¤í–‰) â˜…
    async function autoFillFromSchedule() {
        try {
            const btn = document.getElementById('loadScheduleBtn');
            btn.textContent = "â³ ë¶ˆëŸ¬ì˜¤ëŠ” ì¤‘...";
            
            const res = await fetch('schedule.json?t=' + Date.now());
            if(!res.ok) throw new Error("ìŠ¤ì¼€ì¤„ íŒŒì¼ ì—†ìŒ");
            
            const data = await res.json();
            const now = new Date();
            let foundGame = null;
            
            // ì˜¤ëŠ˜ ë‚ ì§œ ì°¾ê¸°
            const todayStr = now.toDateString(); 
            
            Object.keys(data).forEach(year => {
                if(Array.isArray(data[year])) {
                    data[year].forEach(g => {
                        let gDate;
                        if(g.date.includes('-')) gDate = new Date(g.date + (g.time ? ' ' + g.time : ''));
                        else gDate = new Date(`${year}/${g.date.replace(/\./g,'/')}` + (g.time ? ' ' + g.time : ''));
                        
                        if(gDate.toDateString() === todayStr) {
                            foundGame = g;
                        }
                    });
                }
            });

            if(foundGame) {
                // ì„±ê³µ
                alert(`âœ… ì˜¤ëŠ˜(${foundGame.date}) ê²½ê¸°ë¥¼ ì°¾ì•˜ìŠµë‹ˆë‹¤!\nìƒëŒ€: ${foundGame.opponent}`);
                
                // í™ˆ/ì–´ì›¨ì´ íŒë‹¨
                const loc = foundGame.location || "";
                const isTaurusHome = (loc.includes('ì²­ì£¼') || loc.includes('ë³¸êµ') || loc.includes('ì²­ì›') || loc.includes('ì¶©ë¶'));

                if(isTaurusHome) {
                    document.getElementById('radioHome').checked = true;
                    document.getElementById('setupHomeName').value = "TAURUS";
                    document.getElementById('setupAwayName').value = foundGame.opponent;
                } else {
                    document.getElementById('radioAway').checked = true;
                    document.getElementById('setupAwayName').value = "TAURUS";
                    document.getElementById('setupHomeName').value = foundGame.opponent;
                }
            } else {
                // ì‹¤íŒ¨
                alert(`âš ï¸ ìŠ¤ì¼€ì¤„ íŒŒì¼ì— ì˜¤ëŠ˜(${now.toLocaleDateString()}) ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤.\n(schedule.json ë‚ ì§œë¥¼ í™•ì¸í•´ì£¼ì„¸ìš”)`);
            }
            btn.textContent = "ğŸ“… ì˜¤ëŠ˜ ìŠ¤ì¼€ì¤„ ë¶ˆëŸ¬ì˜¤ê¸° (Click)";

        } catch(e) {
            alert("ì˜¤ë¥˜: " + e.message);
            document.getElementById('loadScheduleBtn').textContent = "ğŸ“… ì˜¤ëŠ˜ ìŠ¤ì¼€ì¤„ ë¶ˆëŸ¬ì˜¤ê¸° (Click)";
        }
    }

    function createLineupInputs(id, pfix) {
        const grid = document.getElementById(id);
        if(grid) {
            grid.innerHTML = '';
            for(let i=0; i<9; i++) grid.innerHTML += `<div class="lineup-row" style="margin-bottom:2px;"><span class="pos-badge">${i+1}</span><input type="text" id="${pfix}${i}" style="width:90px; padding:4px;"></div>`;
        }
    }
    function bindEvent(id, type, handler) { const el = document.getElementById(id); if(el) el.addEventListener(type, handler); }
    function handleLogin() { if(document.getElementById('adminPw').value==='taurus') { document.getElementById('loginLayer').style.display='none'; document.getElementById('adminPanel').style.display='block'; } else alert('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜'); }

    async function startGame() {
        try {
            if (!db) throw new Error("DB ì—°ê²° ì‹¤íŒ¨");
            gameState = {
                teams: { away: '', home: '' },
                inningStr: '1íšŒì´ˆ', isTop: true,
                score: { away: 0, home: 0 },
                bso: { b:0, s:0, o:0 },
                runners: { b1: null, b2: null, b3: null },
                lineups: { away: [], home: [] },
                pitchers: { away: {name:'',total:0,s:0,b:0}, home: {name:'',total:0,s:0,b:0} },
                batIdx: { away: 0, home: 0 },
                currentPitchLog: []
            };

            const homeAwayRadio = document.querySelector('input[name="homeAway"]:checked');
            if (!homeAwayRadio) throw new Error("ì„ ê³µ/í›„ê³µì„ ì„ íƒí•´ì£¼ì„¸ìš”.");

            gameState.teams.away = (document.getElementById('setupAwayName').value || 'Away').trim();
            gameState.teams.home = (document.getElementById('setupHomeName').value || 'Home').trim();
            gameState.pitchers.away = { name: (document.getElementById('startPitcherAway').value || 'ì›ì •íˆ¬ìˆ˜').trim(), total:0, s:0, b:0 };
            gameState.pitchers.home = { name: (document.getElementById('startPitcherHome').value || 'í™ˆíˆ¬ìˆ˜').trim(), total:0, s:0, b:0 };
            gameState.lineups.away = readLineupInputs('awayP');
            gameState.lineups.home = readLineupInputs('homeP');
            gameState.isTop = true; 
            gameState.inningStr = '1íšŒì´ˆ';

            await set(ref(db, 'status'), gameState);
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
            renderBoard();
        } catch(err) {
            console.error(err);
            alert("âš ï¸ ì˜¤ë¥˜: " + err.message);
        }
    }

    function readLineupInputs(pfix) {
        let arr = [];
        for(let i=0; i<9; i++) {
            const el = document.getElementById(pfix+i);
            const val = el ? el.value.trim() : '';
            arr.push({ name: val || `íƒ€ì${i+1}`, ab:0, h:0, rbi:0, bb:0, k:0 });
        }
        return arr;
    }

    async function handlePitch(type) {
        const defSide = gameState.isTop ? 'home' : 'away'; 
        const pitcher = gameState.pitchers[defSide];
        let logMsg = '';
        let count = gameState.currentPitchLog.length + 1;

        pitcher.total++;
        if(type === 'ball') {
            pitcher.b++; gameState.bso.b++;
            logMsg = `${count}êµ¬ ë³¼`; gameState.currentPitchLog.push('B');
            if(gameState.bso.b >= 4) { logMsg += ' -> ë³¼ë„· ì¶œë£¨'; processPlay('bb', true); return; }
        } else {
            pitcher.s++;
            if(type !== 'foul' || gameState.bso.s < 2) gameState.bso.s++;
            if(type === 'look') { logMsg = `${count}êµ¬ ìŠ¤íŠ¸ë¼ì´í¬ (ë£¨í‚¹)`; gameState.currentPitchLog.push('S'); }
            else if(type === 'swing') { logMsg = `${count}êµ¬ í—›ìŠ¤ìœ™`; gameState.currentPitchLog.push('S'); }
            else if(type === 'foul') { logMsg = `${count}êµ¬ íŒŒìš¸`; gameState.currentPitchLog.push('F'); }
            if(gameState.bso.s >= 3) { logMsg += ' -> ì‚¼ì§„ ì•„ì›ƒ'; processPlay(type==='look'?'k_look':'k_swing', true); return; }
        }
        log(logMsg); await syncAll(); renderBoard();
    }

    function handleAction(act) { if(act.includes('_menu')) openModal(act); else processPlay(act); }

    async function processPlay(code, skipLog) {
        const atkSide = gameState.isTop ? 'away' : 'home';
        const batterIdx = gameState.batIdx[atkSide];
        const batter = gameState.lineups[atkSide][batterIdx];
        
        if(!['bb','k_look','k_swing','not_out','hbp'].includes(code)) {
            const defSide = gameState.isTop ? 'home' : 'away';
            gameState.pitchers[defSide].total++; gameState.pitchers[defSide].s++;
            gameState.currentPitchLog.push('Hit');
        }

        const countStr = (gameState.currentPitchLog.length) + "êµ¬ íƒ€ê²©";
        let logText = `[${batterIdx+1}ë²ˆ ${batter.name}] `;
        if(!skipLog) logText += countStr + " -> ";

        if(['1b','2b','3b','hr','inf_hit'].includes(code)) {
            batter.ab++; batter.h++;
            if(code==='1b') { logText += 'ì¢Œì „ ì•ˆíƒ€!'; advanceRunners(1); gameState.runners.b1 = batter.name; }
            else if(code==='2b') { logText += '2ë£¨íƒ€!'; advanceRunners(2); gameState.runners.b2 = batter.name; }
            else if(code==='3b') { logText += '3ë£¨íƒ€!'; advanceRunners(3); gameState.runners.b3 = batter.name; }
            else if(code==='hr') { logText += 'í™ˆëŸ°!!'; batter.rbi++; batter.run++; advanceRunners(4); }
            else if(code==='inf_hit') { logText += 'ë‚´ì•¼ ì•ˆíƒ€!'; advanceRunners(1); gameState.runners.b1 = batter.name; }
        }
        else if(['go','fo','k_swing','k_look'].includes(code)) {
            batter.ab++;
            if(code.startsWith('k')) { batter.k++; if(!skipLog) logText += 'ì‚¼ì§„ ì•„ì›ƒ'; }
            else if(code==='go') logText += 'ë•…ë³¼ ì•„ì›ƒ'; else if(code==='fo') logText += 'ëœ¬ê³µ ì•„ì›ƒ';
            addOut();
        }
        else if(['bb','hbp','ibb'].includes(code)) {
            batter.bb++; if(!skipLog) logText += (code==='hbp'?'ëª¸ì— ë§ëŠ” ê³µ':'ë³¼ë„·');
            pushRunners(); gameState.runners.b1 = batter.name;
        }
        else if(code === 'fc_safe') {
            batter.ab++; logText += 'ì•¼ìˆ˜ì„ íƒ ì¶œë£¨'; addOut();
            if(gameState.runners.b1) gameState.runners.b1 = null; gameState.runners.b1 = batter.name;
        }
        else if(code === 'dp') { batter.ab++; logText += 'ë³‘ì‚´íƒ€'; addOut(); addOut(); if(gameState.runners.b1) gameState.runners.b1=null; }
        else if(code === 'error_safe') { batter.ab++; logText += 'ì‹¤ì±… ì¶œë£¨'; pushRunners(); gameState.runners.b1 = batter.name; }

        nextBatter(); resetCount(); log(logText); await syncAll(); renderBoard();
    }

    function advanceRunners(bases) {
        let r = gameState.runners; let scored = 0;
        const atkSide = gameState.isTop ? 'away' : 'home';
        if(r.b3) { r.b3=null; scored++; }
        if(r.b2) { if(bases>=2){r.b2=null; scored++;} else {r.b3=r.b2; r.b2=null;} }
        if(r.b1) { if(bases>=3){r.b1=null; scored++;} else if(bases===2){r.b3=r.b1; r.b1=null;} else {r.b2=r.b1; r.b1=null;} }
        if(scored>0) { addScore(scored); gameState.lineups[atkSide][gameState.batIdx[atkSide]].rbi += scored; }
    }
    function pushRunners() {
        let r = gameState.runners; const atkSide = gameState.isTop ? 'away' : 'home';
        if(r.b1) {
            if(r.b2) {
                if(r.b3) { addScore(1); gameState.lineups[atkSide][gameState.batIdx[atkSide]].rbi++; } else r.b3=r.b2;
            } else r.b2=r.b1;
        }
    }
    function addOut() {
        gameState.bso.o++;
        if(gameState.bso.o >= 3) {
            alert("3ì•„ì›ƒ! ê³µìˆ˜êµëŒ€ í•©ë‹ˆë‹¤."); gameState.bso.o = 0; gameState.runners = {b1:null, b2:null, b3:null}; changeInning(1);
        }
    }
    function addScore(n) { if(gameState.isTop) gameState.score.away+=n; else gameState.score.home+=n; }
    function nextBatter() { const s = gameState.isTop?'away':'home'; gameState.batIdx[s] = (gameState.batIdx[s]+1)%9; }
    function resetCount() { gameState.bso.b=0; gameState.bso.s=0; gameState.currentPitchLog=[]; }
    function changeInning(delta) {
        let s = gameState.inningStr; let num = parseInt(s);
        if(delta > 0) {
            if(gameState.isTop) { gameState.inningStr = `${num}íšŒë§`; gameState.isTop = false; }
            else { gameState.inningStr = `${num+1}íšŒì´ˆ`; gameState.isTop = true; }
        } else {
            if(gameState.isTop && num===1) return;
            if(!gameState.isTop) { gameState.inningStr = `${num}íšŒì´ˆ`; gameState.isTop = true; }
            else { gameState.inningStr = `${num-1}íšŒë§`; gameState.isTop = false; }
        }
        resetCount(); log(`=== ${gameState.inningStr} ì‹œì‘ ===`); syncAll(); renderBoard();
    }
    
    window.changeCurrentBatter = () => {
        const side = gameState.isTop ? 'away' : 'home'; const curIdx = gameState.batIdx[side];
        const newName = prompt(`íƒ€ì êµì²´:`, gameState.lineups[side][curIdx].name);
        if(newName) { gameState.lineups[side][curIdx].name = newName; log(`[êµì²´] ëŒ€íƒ€ ${newName}`); syncAll(); renderBoard(); }
    };
    window.changeCurrentPitcher = () => {
        const side = gameState.isTop ? 'home' : 'away';
        const newName = prompt(`íˆ¬ìˆ˜ êµì²´ (í˜„: ${gameState.pitchers[side].name})`);
        if(newName) {
            gameState.pitchers[side].name = newName;
            gameState.pitchers[side].total = 0; gameState.pitchers[side].s=0; gameState.pitchers[side].b=0;
            log(`[êµì²´] íˆ¬ìˆ˜ ${newName}`); syncAll(); renderBoard();
        }
    };
    window.sendManualTextFn = () => { const box=document.getElementById('manualInputBox'); if(box.style.display==='none')box.style.display='block'; else{ const t=document.getElementById('comment').value; if(t){log(t);document.getElementById('comment').value='';} } };
    window.handleBaseClick = (base) => { if(gameState.runners[base]){if(confirm("ì‚­ì œ?")){gameState.runners[base]=null;syncAll();renderBoard();}}else{const n=prompt("ì´ë¦„:");if(n){gameState.runners[base]=n;syncAll();renderBoard();}} };
    
    function openModal(act) { const m=document.getElementById('actionModal'); const b=document.getElementById('amButtons'); b.innerHTML=''; m.style.display='flex'; let btns=[];
        if(act==='gnd_menu') btns=[{txt:'ë•…ë³¼',code:'go'},{txt:'ì•¼ì„ ',code:'fc_safe'},{txt:'ë³‘ì‚´',code:'dp'}];
        else if(act==='fly_menu') btns=[{txt:'ëœ¬ê³µ',code:'fo'}];
        else if(act==='k_menu') btns=[{txt:'í—›ìŠ¤ìœ™K',code:'k_swing'},{txt:'ë£¨í‚¹K',code:'k_look'}];
        else if(act==='bb_menu') btns=[{txt:'ë³¼ë„·',code:'bb'},{txt:'ëª¸ë§ê³µ',code:'hbp'}];
        else if(act==='err_menu') btns=[{txt:'ì‹¤ì±… ì¶œë£¨',code:'error_safe'}];
        btns.forEach(i=>{ const btn=document.createElement('button'); btn.className='am-btn'; btn.textContent=i.txt; btn.onclick=()=>{processPlay(i.code);closeModal();}; b.appendChild(btn); });
    }
    function closeModal() { document.getElementById('actionModal').style.display='none'; }
    async function syncAll() { if(db) await update(ref(db, 'status'), gameState); }
    function log(msg) { if(db) push(ref(db, 'logs'), { text: msg, time: new Date().toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'}), notice: false }); }
    
    function renderBoard() {
        const g = gameState;
        if(!g.lineups || !g.pitchers) return;
        document.getElementById('scAway').textContent = g.score.away;
        document.getElementById('scHome').textContent = g.score.home;
        document.getElementById('dispAway').textContent = g.teams.away;
        document.getElementById('dispHome').textContent = g.teams.home;
        document.getElementById('inningVal').textContent = g.inningStr;
        document.getElementById('dispB').textContent = g.bso.b;
        document.getElementById('dispS').textContent = g.bso.s;
        document.getElementById('dispO').textContent = g.bso.o;
        ['b1','b2','b3'].forEach(k => {
            const el = document.querySelector(`[data-base="${k}"]`);
            if(el) { if(g.runners[k]) { el.classList.add('active'); el.title=g.runners[k]; } else { el.classList.remove('active'); el.title=''; } }
        });
        const atkSide = g.isTop ? 'away' : 'home';
        const curBatIdx = g.batIdx[atkSide];
        if(g.lineups[atkSide] && g.lineups[atkSide][curBatIdx]) {
            const batter = g.lineups[atkSide][curBatIdx];
            document.getElementById('currentBatterInfo').textContent = `íƒ€ì„: ${curBatIdx+1}ë²ˆ ${batter.name}`;
            document.getElementById('currentBatterStat').textContent = `(ì˜¤ëŠ˜ ${batter.ab}íƒ€ìˆ˜ ${batter.h}ì•ˆíƒ€)`;
        }
        const defSide = g.isTop ? 'home' : 'away';
        if(g.pitchers[defSide]) {
            const pitcher = g.pitchers[defSide];
            document.getElementById('currentPitcherName').textContent = pitcher.name;
            document.getElementById('pitchCountTotal').textContent = pitcher.total;
            document.getElementById('pitchCountS').textContent = pitcher.s;
            document.getElementById('pitchCountB').textContent = pitcher.b;
        }
    }
    
    onValue(ref(db, 'status'), (snap) => {
        const d = snap.val();
        if(d) {
            gameState = d; 
            if(!gameState.pitchers) gameState.pitchers = {away:{name:'',total:0,s:0,b:0}, home:{name:'',total:0,s:0,b:0}};
            if(!gameState.lineups) gameState.lineups = {away:[], home:[]};
            if(!gameState.teams) gameState.teams = {away:'AWAY', home:'HOME'};
            renderBoard();
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
        }
    });

    function resetGame() { if(confirm("ì´ˆê¸°í™”?")) { set(ref(db, 'status'), null); set(ref(db, 'logs'), null); location.reload(); } }
  </script>
</body>
</html>