<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAURUS MANAGER (FINAL)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
    .control-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
    .btn { padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; border: 1px solid #ccc; font-size: 15px; touch-action: manipulation; }
    
    .btn-hit { background: #ffebee; color: #d32f2f; border-color: #ffcdd2; }
    .btn-out { background: #eceff1; color: #455a64; border-color: #cfd8dc; }
    .btn-run { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
    
    .btn-ball { background: #2e7d32; color: #fff; }
    .btn-strk { background: #fbc02d; color: #000; }
    .btn-foul { background: #546e7a; color: #fff; }

    /* Undo & Reset */
    .admin-tools { display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ccc; }
    .btn-undo { background: #ff9800; color: #fff; flex: 2; }
    .btn-reset { background: #d32f2f; color: #fff; flex: 1; }

    /* ì‹œë‚˜ë¦¬ì˜¤ ëª¨ë‹¬ */
    .scenario-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; }
    .sm-box { background: #fff; width: 90%; max-width: 380px; padding: 20px; border-radius: 12px; text-align: center; }
    
    .field-editor { position: relative; height: 150px; background: #2e7d32; border-radius: 8px; margin: 15px 0; border: 2px solid #fff; }
    .base-chk { position: absolute; width: 40px; height: 40px; background: #fff; transform: rotate(45deg); cursor: pointer; border: 3px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color:#999; transition:0.2s; }
    .base-chk.checked { background: #ffeb3b; border-color: #d32f2f; color:#d32f2f; box-shadow: 0 0 10px #ffeb3b; }
    .base-chk span { transform: rotate(-45deg); }
    .bc-1 { right: 25px; top: 55px; } .bc-2 { left: 50%; top: 10px; margin-left: -20px; } .bc-3 { left: 25px; top: 55px; }
    
    .score-control { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 15px 0; background: #eee; padding: 10px; border-radius: 8px; }
    .score-btn { width: 35px; height: 35px; border-radius: 50%; border: none; background: #333; color: #fff; font-size: 20px; cursor: pointer; }
    .confirm-btn { width: 100%; padding: 15px; background: #1565c0; color: #fff; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    
    .opt-group { display: flex; gap: 5px; margin-bottom: 10px; }
    .opt-btn { flex: 1; padding: 10px; font-size: 13px; border: 1px solid #999; background: #fff; cursor: pointer; border-radius: 4px; }
    .opt-btn.selected { background: #333; color: #fff; border-color: #000; }

    .info-bar { background: #263238; color: #fff; padding: 12px; margin-bottom: 10px; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body style="background:#f0f0f0;">

  <div id="loginLayer" class="admin-login-overlay">
    <h2>âš¾ TAURUS ADMIN</h2>
    <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:12px; margin:10px; text-align:center;">
    <button id="loginBtn" style="padding:10px 30px; font-weight:bold;">ì…ì¥</button>
  </div>

  <main id="adminPanel" class="admin-panel">
    
    <div id="setupView" style="padding:20px; background:#fff;">
      <h3>ğŸ› ï¸ ê²½ê¸° ì„¤ì •</h3>
      <button id="loadScheduleBtn" class="btn" style="width:100%; margin-bottom:15px; background:#e3f2fd; color:#1565c0;">ğŸ“… ì˜¤ëŠ˜ ìŠ¤ì¼€ì¤„ ë¶ˆëŸ¬ì˜¤ê¸°</button>
      
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <div style="flex:1">
          <label>ì›ì • (First)</label>
          <input type="text" id="awayName" value="TAURUS" style="width:100%; text-align:center; font-weight:bold; padding:8px;">
          <input type="text" id="awayPitcher" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; margin-top:5px; text-align:center;">
          <div id="awayLineup"></div> </div>
        <div style="flex:1">
          <label>í™ˆ (Last)</label>
          <input type="text" id="homeName" placeholder="ìƒëŒ€íŒ€" style="width:100%; text-align:center; font-weight:bold; padding:8px;">
          <input type="text" id="homePitcher" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; margin-top:5px; text-align:center;">
          <div id="homeLineup"></div> </div>
      </div>
      <div style="margin-top:10px; text-align:center;">
        <label><input type="radio" name="firstAttack" value="away" checked> ì›ì • ì„ ê³µ</label>
        <label><input type="radio" name="firstAttack" value="home"> í™ˆ ì„ ê³µ</label>
      </div>
      <button id="startBtn" class="btn" style="width:100%; background:#2e7d32; color:#fff; margin-top:10px;">ê²½ê¸° ì‹œì‘ (PLAY BALL)</button>
    </div>

    <div id="gameView" style="display:none;">
      <div class="info-bar">
        <span><span id="d_away">AWAY</span> <span id="s_away" style="font-weight:bold; font-size:20px; color:#ffeb3b;">0</span></span>
        <span id="d_inn" style="background:#000; padding:2px 8px; border-radius:4px; font-size:14px;">1íšŒì´ˆ</span>
        <span><span id="s_home" style="font-weight:bold; font-size:20px; color:#ffeb3b;">0</span> <span id="d_home">HOME</span></span>
      </div>
      
      <div style="background:#fff; padding:10px; margin-bottom:10px; border-bottom:1px solid #ddd;">
        <div style="text-align:center; font-size:18px; font-weight:bold; margin-bottom:5px;">
          <span style="color:green">B <span id="cnt_b">0</span></span>
          <span style="color:#fbc02d">S <span id="cnt_s">0</span></span>
          <span style="color:red">O <span id="cnt_o">0</span></span>
        </div>
        <div style="text-align:center; font-size:12px; color:#555;">
          íˆ¬ìˆ˜: <span id="cur_pit">-</span> (Total:<span id="pit_t">0</span> / S:<span id="pit_s">0</span> B:<span id="pit_b">0</span>)
        </div>
        <div style="text-align:center; font-size:14px; margin-top:5px;">
          íƒ€ì„: <span id="cur_bat" style="color:#1976d2; font-weight:bold;">-</span> <span id="cur_avg" style="font-size:12px; color:#999;">-</span>
        </div>
      </div>

      <div style="padding:10px;">
        <h4 style="margin:0 0 5px 0; color:#555;">âš¾ íˆ¬êµ¬</h4>
        <div class="control-grid">
          <button class="btn btn-ball" onclick="sendPitch('b')">ë³¼</button>
          <button class="btn btn-strk" onclick="sendPitch('s')">ìŠ¤íŠ¸ë¼ì´í¬</button>
          <button class="btn btn-strk" onclick="sendPitch('swing')">í—›ìŠ¤ìœ™</button>
          <button class="btn btn-foul" onclick="sendPitch('f')">íŒŒìš¸</button>
        </div>

        <h4 style="margin:15px 0 5px 0; color:#555;">ğŸƒ ì£¼ì ì•¡ì…˜</h4>
        <div class="control-grid" style="grid-template-columns: repeat(2, 1fr);">
           <button class="btn btn-run" onclick="openScenario('sb', 'sb')">ë„ë£¨ ì„±ê³µ</button>
           <button class="btn btn-run" onclick="openScenario('adv', 'wp')">í­íˆ¬/í¬ì¼ ì§„ë£¨</button>
        </div>

        <h4 style="margin:15px 0 5px 0; color:#555;">ğŸ’¥ íƒ€ê²© ê²°ê³¼</h4>
        <div class="control-grid">
          <button class="btn btn-hit" onclick="openScenario('hit', 1)">ì•ˆíƒ€</button>
          <button class="btn btn-hit" onclick="openScenario('hit', 2)">2ë£¨íƒ€</button>
          <button class="btn btn-hit" onclick="openScenario('hit', 3)">3ë£¨íƒ€</button>
          <button class="btn btn-hit" onclick="openScenario('hr', 4)">í™ˆëŸ°</button>
          
          <button class="btn btn-out" onclick="openScenario('out', 'go')">ë•…ë³¼</button>
          <button class="btn btn-out" onclick="openScenario('out', 'fo')">ëœ¬ê³µ</button>
          <button class="btn btn-out" onclick="openScenario('k', 'so')">ì‚¼ì§„</button>
          <button class="btn btn-out" onclick="openScenario('out', 'dp')">ë³‘ì‚´</button>
          
          <button class="btn btn-run" onclick="openScenario('4ball', 'bb')">ë³¼ë„·</button>
          <button class="btn btn-run" onclick="openScenario('4ball', 'hbp')">ì‚¬êµ¬</button>
          <button class="btn btn-out" onclick="openScenario('err', 'err')">ì‹¤ì±…</button>
          <button class="btn btn-out" onclick="openScenario('etc', 'fc')">ì•¼ì„ </button>
        </div>
        
        <div style="margin-top:20px; display:flex; gap:5px;">
           <button class="btn" style="flex:1; background:#fff;" onclick="changePitcher()">íˆ¬ìˆ˜êµì²´</button>
           <button class="btn" style="flex:1; background:#fff;" onclick="changeBatter()">ëŒ€íƒ€</button>
           <button class="btn" style="flex:1; background:#444; color:#fff;" onclick="endGame()">ê²½ê¸°ì¢…ë£Œ</button>
        </div>

        <div class="admin-tools">
            <button class="btn btn-undo" onclick="undoLastAction()">â†©ï¸ ì‹¤í–‰ ì·¨ì†Œ (Undo)</button>
            <button class="btn btn-reset" onclick="resetGame()">âš ï¸ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </main>

  <div id="scenarioModal" class="scenario-modal">
    <div class="sm-box">
      <h3 id="smTitle" style="margin-top:0; border-bottom:2px solid #333; padding-bottom:10px;">ê²°ê³¼ í™•ì •</h3>
      <div id="hitLocBox" class="opt-group" style="display:none;">
        <button class="opt-btn" onclick="selLoc(this, 'ì¢Œì „')">ì¢Œì¸¡</button>
        <button class="opt-btn" onclick="selLoc(this, 'ì¤‘ì „')">ì¤‘ì•™</button>
        <button class="opt-btn" onclick="selLoc(this, 'ìš°ì „')">ìš°ì¸¡</button>
        <button class="opt-btn" onclick="selLoc(this, 'ë‚´ì•¼')">ë‚´ì•¼</button>
      </div>
      <p style="font-size:12px; color:#666;">â–¼ ìµœì¢… ì£¼ì ìœ„ì¹˜ë¥¼ ì²´í¬í•˜ì„¸ìš”</p>
      <div class="field-editor">
        <div id="chk3" class="base-chk bc-3" onclick="toggleBase(3)"><span>3ë£¨</span></div>
        <div id="chk2" class="base-chk bc-2" onclick="toggleBase(2)"><span>2ë£¨</span></div>
        <div id="chk1" class="base-chk bc-1" onclick="toggleBase(1)"><span>1ë£¨</span></div>
      </div>
      <div class="score-control">
        <span style="font-weight:bold;">ì¶”ê°€ ë“ì :</span>
        <button class="score-btn" onclick="adjScore(-1)">-</button>
        <span id="scoreInput" style="font-size:24px; font-weight:bold; width:40px;">0</span>
        <button class="score-btn" onclick="adjScore(1)">+</button>
      </div>
      <button class="confirm-btn" onclick="submitScenario()">ì „ì†¡</button>
      <button onclick="closeScenario()" style="margin-top:15px; background:none; border:none; color:#666; cursor:pointer;">ì·¨ì†Œ</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, update, onValue, query, limitToLast, get, remove, orderByKey } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMVkogwvzoQon3lo0_hiVewfoXxmvbYMU",
      authDomain: "taurus-cbnu.firebaseapp.com",
      databaseURL: "https://taurus-cbnu-default-rtdb.firebaseio.com",
      projectId: "taurus-cbnu",
      storageBucket: "taurus-cbnu.firebasestorage.app",
      messagingSenderId: "598393475132",
      appId: "1:598393475132:web:b266ef01509e6c20dd7339"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let game = {}; 
    let temp = { type:'', detail:'', runs:0, runners:[false,false,false], loc:'' };
    let historyStack = []; // Undoìš©

    document.addEventListener('DOMContentLoaded', () => {
      // â˜… ID ìƒì„± ë¡œì§ (ì—¬ê¸°ê°€ ë¬¸ì œì˜€ìŒ, í™•ì‹¤í•˜ê²Œ ê³ ì¹¨)
      const mk = (id, prefix) => {
        const div = document.getElementById(id); div.innerHTML='';
        for(let i=0;i<9;i++) {
            // IDë¥¼ 'a0', 'a1' ... 'h0', 'h1' ë¡œ ëª…í™•í•˜ê²Œ ìƒì„±
            div.innerHTML += `<input id="${prefix}${i}" placeholder="${i+1}ë²ˆ íƒ€ì" style="width:100%; margin:2px 0; padding:6px;">`;
        }
      };
      mk('awayLineup','a'); // a0 ~ a8
      mk('homeLineup','h'); // h0 ~ h8

      document.getElementById('loginBtn').onclick=()=>{
         if(document.getElementById('adminPw').value==='taurus'){document.getElementById('loginLayer').style.display='none';document.getElementById('adminPanel').style.display='block';}
      };
      document.getElementById('loadScheduleBtn').onclick=loadSchedule;
      document.getElementById('startBtn').onclick=startGame;
    });

    // --- ìƒíƒœ ì €ì¥ (Undo) ---
    function saveState() {
        if(historyStack.length > 5) historyStack.shift();
        historyStack.push(JSON.parse(JSON.stringify(game)));
    }

    // --- ì‹¤í–‰ ì·¨ì†Œ (Undo) ---
    window.undoLastAction = async () => {
        if(historyStack.length === 0) { alert("ë˜ëŒë¦´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        game = historyStack.pop();
        await update(ref(db, 'status'), game);
        
        // ë§ˆì§€ë§‰ ë¡œê·¸ ì‚­ì œ
        const logsRef = ref(db, 'logs');
        get(query(logsRef, orderByKey(), limitToLast(1))).then((s) => {
            s.forEach((c) => remove(c.ref));
        });
        alert("ë³µêµ¬ë¨!");
        render();
    };

    // --- ìŠ¤ì¼€ì¤„ ë¶ˆëŸ¬ì˜¤ê¸° (ë‚ ì§œë§Œ ë§ìœ¼ë©´ OK) ---
    async function loadSchedule() {
       try {
          const res = await fetch('schedule.json?t='+Date.now());
          const data = await res.json();
          const now = new Date();
          let found = null;
          Object.values(data).flat().forEach(g => {
             // 00:00 ì‹œê°„ ë¬´ì‹œí•˜ê³  ë‚ ì§œë§Œ ë¹„êµ
             let dateStr = g.date.replace(/[-.]/g, '/'); // êµ¬ë¶„ì í†µì¼
             let d = new Date(dateStr);
             
             // ì—°ë„ ì—†ìœ¼ë©´ ë¶™ì´ê¸°
             if(isNaN(d.getTime())) d = new Date(`${now.getFullYear()}/${dateStr}`);
             
             // ë…„/ì›”/ì¼ ì¼ì¹˜ í™•ì¸
             if(d.getDate() === now.getDate() && d.getMonth() === now.getMonth()) found = g;
          });

          if(found) {
             alert(`ê²½ê¸° ë°œê²¬! ${found.opponent}`);
             document.getElementById('homeName').value = found.opponent;
             if(found.location && (found.location.includes('ì²­ì£¼') || found.location.includes('ë³¸êµ'))) {
                document.querySelectorAll('input[name="firstAttack"]')[1].checked = true; // í™ˆ ì„ ê³µ
                document.getElementById('homeName').value = 'TAURUS';
                document.getElementById('awayName').value = found.opponent;
             }
          } else alert('ì˜¤ëŠ˜ ë‚ ì§œ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì§ì ‘ ì…ë ¥í•˜ì„¸ìš”)');
       } catch(e) { alert('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì˜¤ë¥˜: ' + e.message); }
    }

    // --- ê²½ê¸° ì‹œì‘ (ì•ˆì „ì¥ì¹˜ ì¶”ê°€) ---
    async function startGame() {
       try {
           const away = document.getElementById('awayName').value;
           const home = document.getElementById('homeName').value;
           const top = document.querySelector('input[name="firstAttack"]:checked').value === 'away';
           
           // ë¼ì¸ì—… ì½ê¸° í•¨ìˆ˜ (ì•ˆì „í•˜ê²Œ)
           const getL = (prefix) => {
              let a=[]; 
              for(let i=0;i<9;i++) {
                  const el = document.getElementById(prefix+i);
                  // ìš”ì†Œê°€ ì—†ìœ¼ë©´ ê¸°ë³¸ê°’ ì²˜ë¦¬ (ì—ëŸ¬ ë°©ì§€)
                  const val = el ? el.value : `íƒ€ì${i+1}`;
                  a.push({name: val || `íƒ€ì${i+1}`, pa:0, ab:0, h:0, bb:0, k:0, rbi:0, r:0});
              }
              return a;
           };

           game = {
              teams: { away, home }, inn: '1íšŒì´ˆ', top,
              score: { away:0, home:0 }, bso: {b:0,s:0,o:0}, runner: {b1:false,b2:false,b3:false},
              lineups: { away: getL('a'), home: getL('h') }, // ID prefix 'a', 'h' ì‚¬ìš©
              pitchers: { away:{ name:document.getElementById('awayPitcher').value||'ì›ì •íˆ¬ìˆ˜', total:0,s:0,b:0,k:0 }, home:{ name:document.getElementById('homePitcher').value||'í™ˆíˆ¬ìˆ˜', total:0,s:0,b:0,k:0 } },
              idx: { away:0, home:0 },
              pitchCountForBatter: 0,
              lastPlay: ''
           };
           
           log(`=== ${game.inn} ì‹œì‘ ===`);
           logNewBatter();
           await sync();
           
           document.getElementById('setupView').style.display='none';
           document.getElementById('gameView').style.display='block';
           
       } catch(err) {
           alert("ê²½ê¸° ì‹œì‘ ì¤‘ ì˜¤ë¥˜ ë°œìƒ: " + err.message + "\n(ë¼ì¸ì—… ì…ë ¥ì¹¸ì„ í™•ì¸í•´ì£¼ì„¸ìš”)");
       }
    }

    // --- íˆ¬êµ¬ ë¡œì§ ---
    window.sendPitch = (type) => {
       saveState();
       const def = game.top ? 'home' : 'away';
       const p = game.pitchers[def];
       game.pitchCountForBatter++;
       p.total++;

       let txt = "";
       if(type==='b') {
          game.bso.b++; p.b++; txt="ë³¼";
          if(game.bso.b>=4) openScenario('4ball', 'bb');
       } else if(type==='s') {
          game.bso.s++; p.s++; txt="ìŠ¤íŠ¸ë¼ì´í¬";
          if(game.bso.s>=3) openScenario('k', 'so');
       } else if(type==='swing') {
          game.bso.s++; p.s++; txt="í—›ìŠ¤ìœ™";
          if(game.bso.s>=3) openScenario('k', 'so');
       } else {
          if(game.bso.s<2) game.bso.s++; p.s++; txt="íŒŒìš¸";
       }
       
       if(txt) log(`${game.pitchCountForBatter}êµ¬ ${txt}`);
       game.lastPlay = txt; // ì•Œë¦¼ìš©
       sync();
    };
    
    window.resetBSO = () => { saveState(); game.bso={b:0,s:0,o:game.bso.o}; game.lastPlay="ë¦¬ì…‹"; sync(); };

    // --- ì‹œë‚˜ë¦¬ì˜¤ ---
    window.openScenario = (type, detail) => {
       document.getElementById('scenarioModal').style.display='flex';
       temp = { type, detail, runs:0, runners:[game.runner.b1, game.runner.b2, game.runner.b3], loc:'ì¤‘ì „' };
       document.getElementById('hitLocBox').style.display = (type==='hit'||type==='err') ? 'flex':'none';
       if(detail===4) {
          let r=1; if(game.runner.b1)r++; if(game.runner.b2)r++; if(game.runner.b3)r++;
          temp.runs = r; temp.runners=[false,false,false];
       }
       updateModal();
    };

    function updateModal() {
       document.getElementById('scoreInput').textContent = temp.runs;
       document.getElementById('chk1').className = 'base-chk bc-1 '+(temp.runners[0]?'checked':'');
       document.getElementById('chk2').className = 'base-chk bc-2 '+(temp.runners[1]?'checked':'');
       document.getElementById('chk3').className = 'base-chk bc-3 '+(temp.runners[2]?'checked':'');
    }
    
    window.toggleBase = (i) => { temp.runners[i-1] = !temp.runners[i-1]; updateModal(); };
    window.adjScore = (n) => { temp.runs+=n; if(temp.runs<0)temp.runs=0; updateModal(); };
    window.selLoc = (e, l) => { document.querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('selected')); e.classList.add('selected'); temp.loc = l; };
    window.closeScenario = () => document.getElementById('scenarioModal').style.display='none';

    // --- ì „ì†¡ ---
    window.submitScenario = () => {
       saveState();
       const atk = game.top ? 'away' : 'home';
       const def = game.top ? 'home' : 'away';
       const bat = game.lineups[atk][game.idx[atk]];
       const pit = game.pitchers[def];
       
       bat.pa++;
       if(temp.type==='hit'||temp.type==='hr'||temp.type==='out'||temp.type==='err'||temp.type==='etc') bat.ab++;
       if(temp.type==='hit'||temp.type==='hr') bat.h++;
       if(temp.type==='4ball') bat.bb++;
       if(temp.type==='k') { bat.k++; bat.ab++; pit.k++; } 
       
       bat.rbi += temp.runs;
       if(temp.runs>0) { if(game.top) game.score.away+=temp.runs; else game.score.home+=temp.runs; }
       
       game.runner.b1 = temp.runners[0];
       game.runner.b2 = temp.runners[1];
       game.runner.b3 = temp.runners[2];
       
       if(temp.type==='out'||temp.type==='k') game.bso.o++;
       
       let txt = "";
       if(temp.type==='hit') txt = `${temp.loc} ì•ˆíƒ€`;
       else if(temp.detail===2) txt = `${temp.loc} 2ë£¨íƒ€`;
       else if(temp.detail===3) txt = `${temp.loc} 3ë£¨íƒ€`;
       else if(temp.detail===4) txt = `í™ˆëŸ°!!!!`;
       else if(temp.type==='k') txt = `ì‚¼ì§„ ì•„ì›ƒ`;
       else if(temp.type==='4ball') txt = `ì‚¬ì‚¬êµ¬ ì¶œë£¨`;
       else if(temp.type==='out') txt = `ë²”íƒ€ ì•„ì›ƒ`;
       else if(temp.type==='sb') txt = `ë„ë£¨ ì„±ê³µ`;
       else if(temp.type==='adv') txt = `í­íˆ¬/í¬ì¼ ì§„ë£¨`;
       else txt = `í”Œë ˆì´ ì¢…ë£Œ`;
       
       if(temp.runs > 0) txt += ` (+${temp.runs}ë“ì )`;
       log(`${game.pitchCountForBatter+1}êµ¬ íƒ€ê²© â–¶ ${txt}`);
       game.lastPlay = txt;

       if(temp.type !== 'sb' && temp.type !== 'adv') {
          if(game.bso.o >= 3) {
             alert('3ì•„ì›ƒ! ê³µìˆ˜êµëŒ€');
             game.idx[atk] = (game.idx[atk]+1)%9;
             changeInn();
          } else {
             game.idx[atk] = (game.idx[atk]+1)%9;
             game.bso.b=0; game.bso.s=0;
             logNewBatter();
          }
       }
       sync();
       closeScenario();
    };

    function changeInn() {
       let n = parseInt(game.inn);
       if(game.top) { game.inn=`${n}íšŒë§`; game.top=false; }
       else { game.inn=`${n+1}íšŒì´ˆ`; game.top=true; }
       game.bso={b:0,s:0,o:0}; game.runner={b1:false,b2:false,b3:false};
       log(`=== ${game.inn} ì‹œì‘ ===`);
       logNewBatter();
    }
    
    function logNewBatter() {
       game.pitchCountForBatter = 0;
       const atk = game.top ? 'away' : 'home';
       const b = game.lineups[atk][game.idx[atk]];
       let avg = b.ab>0 ? (b.h/b.ab).toFixed(3) : '.000';
       log(`[${game.idx[atk]+1}ë²ˆ ${b.name}] íƒ€ìœ¨ ${avg}`);
    }

    async function sync() { await update(ref(db, 'status'), game); render(); }
    function log(m) { push(ref(db, 'logs'), { text:m, time:new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}), notice:false }); }
    
    function render() {
       document.getElementById('s_away').textContent = game.score.away;
       document.getElementById('s_home').textContent = game.score.home;
       document.getElementById('d_away').textContent = game.teams.away;
       document.getElementById('d_home').textContent = game.teams.home;
       document.getElementById('d_inn').textContent = game.inn;
       
       document.getElementById('cnt_b').textContent = game.bso.b;
       document.getElementById('cnt_s').textContent = game.bso.s;
       document.getElementById('cnt_o').textContent = game.bso.o;
       
       const def = game.top?'home':'away';
       const pit = game.pitchers[def];
       document.getElementById('cur_pit').textContent = pit.name;
       document.getElementById('pit_t').textContent = pit.total;
       document.getElementById('pit_s').textContent = pit.s;
       document.getElementById('pit_b').textContent = pit.b;

       const atk = game.top?'away':'home';
       const bat = game.lineups[atk][game.idx[atk]];
       let avg = bat.ab>0 ? (bat.h/bat.ab).toFixed(3) : '.000';
       document.getElementById('cur_bat').textContent = `${game.idx[atk]+1}ë²ˆ ${bat.name}`;
       document.getElementById('cur_avg').textContent = `(íƒ€ìœ¨ ${avg})`;
    }
    
    onValue(ref(db, 'status'), (s)=>{ if(s.val()){ game=s.val(); render(); 
       if(document.getElementById('setupView').style.display!=='none'){
          document.getElementById('setupView').style.display='none'; document.getElementById('gameView').style.display='block';
       }}
    });
    
    window.changeBatter = ()=>{ saveState(); const atk=game.top?'away':'home'; const n=prompt('ëŒ€íƒ€'); if(n){game.lineups[atk][game.idx[atk]].name=n; log(`ëŒ€íƒ€ ${n}`); sync();} };
    window.changePitcher = ()=>{ saveState(); const def=game.top?'home':'away'; const n=prompt('íˆ¬ìˆ˜êµì²´'); if(n){game.pitchers[def]={name:n,total:0,s:0,b:0,k:0}; log(`íˆ¬ìˆ˜êµì²´ ${n}`); sync();} };
    window.endGame = ()=>{ const r={date:new Date().toLocaleDateString(), opponent:game.teams.home==='TAURUS'?game.teams.away:game.teams.home, score:`${game.score.away}:${game.score.home}`, result:'ì¢…ë£Œ'}; prompt('ë³µì‚¬í•´ì„œ schedule.jsonì—:', JSON.stringify(r)); };
    
    window.resetGame = () => { if(confirm("ì •ë§ ì´ˆê¸°í™”?")) { set(ref(db, 'status'), null); set(ref(db, 'logs'), null); location.reload(); } };
  </script>
</body>
</html>