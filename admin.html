<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAURUS ADMIN (Season Stats)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ê¸°ë³¸ ìŠ¤íƒ€ì¼ */
    body { font-family: 'Pretendard', sans-serif; background: #f0f2f5; margin: 0; }
    
    /* ì…ë ¥ í•„ë“œ ìŠ¤íƒ€ì¼ ê°œì„  */
    .lineup-row { display: flex; gap: 5px; margin-bottom: 5px; }
    .lineup-row input { padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 13px; }
    .inp-name { flex: 2; font-weight: bold; }
    .inp-stat { flex: 1; text-align: center; background: #fafafa; }

    /* ì»¨íŠ¸ë¡¤ íŒ¨ë„ */
    .control-grid { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 10px; }
    .btn { padding: 14px; border-radius: 8px; font-weight: bold; cursor: pointer; border: 1px solid #ccc; font-size: 15px; touch-action: manipulation; }
    .btn-hit { background: #ffebee; color: #d32f2f; border-color: #ffcdd2; }
    .btn-out { background: #eceff1; color: #455a64; border-color: #cfd8dc; }
    .btn-run { background: #e8f5e9; color: #2e7d32; border-color: #c8e6c9; }
    .btn-ball { background: #2e7d32; color: #fff; }
    .btn-strk { background: #fbc02d; color: #000; }
    .btn-foul { background: #546e7a; color: #fff; }
    
    .admin-tools { display: flex; gap: 10px; margin-top: 20px; padding-top: 15px; border-top: 2px dashed #ccc; }
    .btn-undo { background: #ff9800; color: #fff; flex: 2; }
    .btn-reset { background: #d32f2f; color: #fff; flex: 1; }

    /* ëª¨ë‹¬ */
    .scenario-modal { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 9999; display: none; align-items: center; justify-content: center; }
    .sm-box { background: #fff; width: 90%; max-width: 380px; padding: 20px; border-radius: 12px; text-align: center; }
    .field-editor { position: relative; height: 150px; background: #2e7d32; border-radius: 8px; margin: 15px 0; border: 2px solid #fff; }
    .base-chk { position: absolute; width: 40px; height: 40px; background: #fff; transform: rotate(45deg); cursor: pointer; border: 3px solid #ccc; display: flex; align-items: center; justify-content: center; font-size: 12px; font-weight: bold; color:#999; transition:0.2s; }
    .base-chk.checked { background: #ffeb3b; border-color: #d32f2f; color:#d32f2f; box-shadow: 0 0 10px #ffeb3b; }
    .base-chk span { transform: rotate(-45deg); }
    .bc-1 { right: 25px; top: 55px; } .bc-2 { left: 50%; top: 10px; margin-left: -20px; } .bc-3 { left: 25px; top: 55px; }
    
    .score-control { display: flex; justify-content: center; align-items: center; gap: 15px; margin: 15px 0; background: #eee; padding: 10px; border-radius: 8px; }
    .score-btn { width: 35px; height: 35px; border-radius: 50%; border: none; background: #333; color: #fff; font-size: 20px; cursor: pointer; }
    .confirm-btn { width: 100%; padding: 15px; background: #1565c0; color: #fff; font-size: 16px; font-weight: bold; border: none; border-radius: 8px; cursor: pointer; margin-top: 10px; }
    .opt-group { display: flex; gap: 5px; margin-bottom: 10px; }
    .opt-btn { flex: 1; padding: 10px; font-size: 13px; border: 1px solid #999; background: #fff; cursor: pointer; border-radius: 4px; }
    .opt-btn.selected { background: #333; color: #fff; border-color: #000; }
    .info-bar { background: #263238; color: #fff; padding: 12px; margin-bottom: 10px; font-size: 16px; display: flex; justify-content: space-between; align-items: center; }
  </style>
</head>
<body>

  <div id="loginLayer" class="admin-login-overlay">
    <h2>âš¾ TAURUS ADMIN</h2>
    <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:12px; margin:10px; text-align:center;">
    <button id="loginBtn" style="padding:10px 30px; font-weight:bold;">ì…ì¥</button>
  </div>

  <main id="adminPanel" class="admin-panel">
    <div id="setupView" style="padding:20px; background:#fff;">
      <h3>ğŸ› ï¸ ê²½ê¸° ì„¤ì •</h3>
      <button id="loadScheduleBtn" class="btn" style="width:100%; margin-bottom:15px; background:#e3f2fd; color:#1565c0;">ğŸ“… ì˜¤ëŠ˜ ê²½ê¸° ë¶ˆëŸ¬ì˜¤ê¸°</button>
      
      <div style="display:flex; gap:10px; margin-bottom:10px;">
        <div style="flex:1">
          <label>ì›ì • (First)</label>
          <input type="text" id="awayName" value="TAURUS" style="width:100%; text-align:center; font-weight:bold; padding:8px; margin-bottom:5px;">
          <input type="text" id="awayPitcher" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; text-align:center; margin-bottom:10px;">
          <div id="awayLineup"></div>
        </div>
        <div style="flex:1">
          <label>í™ˆ (Last)</label>
          <input type="text" id="homeName" placeholder="ìƒëŒ€íŒ€" style="width:100%; text-align:center; font-weight:bold; padding:8px; margin-bottom:5px;">
          <input type="text" id="homePitcher" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; text-align:center; margin-bottom:10px;">
          <div id="homeLineup"></div>
        </div>
      </div>
      <div style="margin-top:10px; text-align:center;">
        <label><input type="radio" name="firstAttack" value="away" checked> ì›ì • ì„ ê³µ</label>
        <label><input type="radio" name="firstAttack" value="home"> í™ˆ ì„ ê³µ</label>
      </div>
      <button id="startBtn" class="btn" style="width:100%; background:#2e7d32; color:#fff; margin-top:10px;">ê²½ê¸° ì‹œì‘ (PLAY BALL)</button>
    </div>

    <div id="gameView" style="display:none;">
      <div class="info-bar">
        <span><span id="d_away">AWAY</span> <span id="s_away" style="font-weight:bold; font-size:20px; color:#ffeb3b;">0</span></span>
        <span id="d_inn" style="background:#000; padding:2px 8px; border-radius:4px; font-size:14px;">1íšŒì´ˆ</span>
        <span><span id="s_home" style="font-weight:bold; font-size:20px; color:#ffeb3b;">0</span> <span id="d_home">HOME</span></span>
      </div>
      
      <div style="background:#fff; padding:10px; margin-bottom:10px; border-bottom:1px solid #ddd;">
        <div style="display:flex; justify-content:space-between; align-items:center;">
           <div style="text-align:left; font-size:14px;">
             íˆ¬ìˆ˜: <span id="cur_pit" style="font-weight:bold;">-</span><br>
             <span style="font-size:12px; color:#666;">(íˆ¬êµ¬ìˆ˜ <span id="pit_cnt">0</span> / S:<span id="pit_s">0</span> B:<span id="pit_b">0</span>)</span>
           </div>
           <div style="font-size:20px; font-weight:bold; letter-spacing:3px;">
             <span style="color:#4caf50">B<span id="cnt_b">0</span></span>
             <span style="color:#fbc02d">S<span id="cnt_s">0</span></span>
             <span style="color:#f44336">O<span id="cnt_o">0</span></span>
           </div>
        </div>
        <div style="text-align:center; font-size:14px; margin-top:5px;">
          íƒ€ì„: <span id="cur_bat" style="color:#1976d2; font-weight:bold;">-</span> <span id="cur_avg" style="font-size:12px; color:#999;">-</span>
        </div>
      </div>

      <div style="padding:10px;">
        <h4 style="margin:0 0 5px 0; color:#555;">âš¾ íˆ¬êµ¬</h4>
        <div class="control-grid">
          <button class="btn btn-ball" onclick="sendPitch('b')">ë³¼</button>
          <button class="btn btn-strk" onclick="sendPitch('s')">ìŠ¤íŠ¸ë¼ì´í¬</button>
          <button class="btn btn-strk" onclick="sendPitch('swing')">í—›ìŠ¤ìœ™</button>
          <button class="btn btn-foul" onclick="sendPitch('f')">íŒŒìš¸</button>
        </div>

        <h4 style="margin:15px 0 5px 0; color:#555;">ğŸƒ ì£¼ì/ë³¼ë„·</h4>
        <div class="control-grid" style="grid-template-columns: repeat(4, 1fr);">
           <button class="btn btn-run" onclick="openScenario('sb', 'sb', false)">ë„ë£¨</button>
           <button class="btn btn-run" onclick="openScenario('adv', 'wp', false)">í­íˆ¬</button>
           <button class="btn btn-run" onclick="openScenario('4ball', 'bb', false)">ë³¼ë„·</button>
           <button class="btn btn-run" onclick="openScenario('4ball', 'hbp', false)">ì‚¬êµ¬</button>
        </div>

        <h4 style="margin:15px 0 5px 0; color:#555;">ğŸ’¥ íƒ€ê²© ê²°ê³¼ (íˆ¬êµ¬ìˆ˜ +1)</h4>
        <div class="control-grid">
          <button class="btn btn-hit" onclick="openScenario('hit', 1, false)">ì•ˆíƒ€</button>
          <button class="btn btn-hit" onclick="openScenario('hit', 2, false)">2ë£¨íƒ€</button>
          <button class="btn btn-hit" onclick="openScenario('hit', 3, false)">3ë£¨íƒ€</button>
          <button class="btn btn-hit" onclick="openScenario('hr', 4, false)">í™ˆëŸ°</button>
          <button class="btn btn-out" onclick="openScenario('out', 'go', false)">ë•…ë³¼</button>
          <button class="btn btn-out" onclick="openScenario('out', 'fo', false)">ëœ¬ê³µ</button>
          <button class="btn btn-out" onclick="openScenario('k', 'so', false)">ì‚¼ì§„</button>
          <button class="btn btn-out" onclick="openScenario('out', 'dp', false)">ë³‘ì‚´</button>
          <button class="btn btn-out" onclick="openScenario('err', 'err', false)">ì‹¤ì±…</button>
          <button class="btn btn-out" onclick="openScenario('etc', 'fc', false)">ì•¼ì„ </button>
        </div>
        
        <div style="margin-top:20px; display:flex; gap:5px;">
           <button class="btn" style="flex:1; background:#fff;" onclick="changePitcher()">íˆ¬ìˆ˜êµì²´</button>
           <button class="btn" style="flex:1; background:#fff;" onclick="changeBatter()">ëŒ€íƒ€</button>
           <button class="btn" style="flex:1; background:#444; color:#fff;" onclick="endGame()">ê²½ê¸°ì¢…ë£Œ</button>
        </div>

        <div class="admin-tools">
            <button class="btn btn-undo" onclick="undoLastAction()">â†©ï¸ ì‹¤í–‰ ì·¨ì†Œ</button>
            <button class="btn btn-reset" onclick="resetGame()">âš ï¸ ì´ˆê¸°í™”</button>
        </div>
      </div>
    </div>
  </main>

  <div id="scenarioModal" class="scenario-modal">
    <div class="sm-box">
      <h3 id="smTitle" style="margin-top:0; border-bottom:2px solid #333; padding-bottom:10px;">ê²°ê³¼ í™•ì •</h3>
      <div id="hitLocBox" class="opt-group" style="display:none;">
        <button class="opt-btn" onclick="selLoc(this, 'ì¢Œì „')">ì¢Œì¸¡</button>
        <button class="opt-btn" onclick="selLoc(this, 'ì¤‘ì „')">ì¤‘ì•™</button>
        <button class="opt-btn" onclick="selLoc(this, 'ìš°ì „')">ìš°ì¸¡</button>
        <button class="opt-btn" onclick="selLoc(this, 'ë‚´ì•¼')">ë‚´ì•¼</button>
      </div>
      <div id="hitLocBox_multi" class="opt-group" style="display:none;">
        <button class="opt-btn" onclick="selLoc(this, 'ì¢Œì„ ìƒ')">ì¢Œì„ </button>
        <button class="opt-btn" onclick="selLoc(this, 'ì¢Œì¤‘ê°„')">ì¢Œì¤‘</button>
        <button class="opt-btn" onclick="selLoc(this, 'ì¤‘ì›”')">ì¤‘ì›”</button>
        <button class="opt-btn" onclick="selLoc(this, 'ìš°ì¤‘ê°„')">ìš°ì¤‘</button>
        <button class="opt-btn" onclick="selLoc(this, 'ìš°ì„ ìƒ')">ìš°ì„ </button>
      </div>
      <p style="font-size:12px; color:#666;">â–¼ ìµœì¢… ì£¼ì ìœ„ì¹˜ë¥¼ ì²´í¬í•˜ì„¸ìš”</p>
      <div class="field-editor">
        <div id="chk3" class="base-chk bc-3" onclick="toggleBase(3)"><span>3ë£¨</span></div>
        <div id="chk2" class="base-chk bc-2" onclick="toggleBase(2)"><span>2ë£¨</span></div>
        <div id="chk1" class="base-chk bc-1" onclick="toggleBase(1)"><span>1ë£¨</span></div>
      </div>
      <div class="score-control">
        <span style="font-weight:bold;">ë“ì :</span>
        <button class="score-btn" onclick="adjScore(-1)">-</button>
        <span id="scoreInput" style="font-size:24px; font-weight:bold; width:40px;">0</span>
        <button class="score-btn" onclick="adjScore(1)">+</button>
      </div>
      <button class="confirm-btn" onclick="submitScenario()">ì „ì†¡</button>
      <button onclick="closeScenario()" style="margin-top:15px; background:none; border:none; color:#666; cursor:pointer;">ì·¨ì†Œ</button>
    </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, update, onValue, query, limitToLast, get, remove, orderByKey } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMVkogwvzoQon3lo0_hiVewfoXxmvbYMU",
      authDomain: "taurus-cbnu.firebaseapp.com",
      databaseURL: "https://taurus-cbnu-default-rtdb.firebaseio.com",
      projectId: "taurus-cbnu",
      storageBucket: "taurus-cbnu.firebasestorage.app",
      messagingSenderId: "598393475132",
      appId: "1:598393475132:web:b266ef01509e6c20dd7339"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let game = {}; 
    let temp = { type:'', detail:'', runs:0, runners:[false,false,false], loc:'', isAuto:false };
    let historyStack = [];

    const setText = (id, val) => { const el = document.getElementById(id); if(el) el.textContent = val; };

    document.addEventListener('DOMContentLoaded', () => {
      // ë¼ì¸ì—… ìƒì„± (í™•ì¥ë¨: ì´ë¦„/íƒ€ìœ¨/OPS)
      const mk = (id, p) => {
        const d=document.getElementById(id); if(d) { d.innerHTML='';
        for(let i=0;i<9;i++) {
            d.innerHTML+=`
            <div class="lineup-row">
                <input class="inp-name" id="${p}_n_${i}" placeholder="${i+1}ë²ˆ íƒ€ìëª…">
                <input class="inp-stat" id="${p}_avg_${i}" placeholder="íƒ€ìœ¨">
                <input class="inp-stat" id="${p}_ops_${i}" placeholder="OPS">
            </div>`;
        }}
      };
      mk('awayLineup','a'); mk('homeLineup','h');

      const bind = (id, fn) => { const el = document.getElementById(id); if(el) el.onclick = fn; };
      bind('loginBtn', ()=>{ if(document.getElementById('adminPw').value==='taurus'){document.getElementById('loginLayer').style.display='none';document.getElementById('adminPanel').style.display='block';} });
      bind('loadScheduleBtn', loadSchedule); bind('startBtn', startGame);
    });

    function saveState() {
        if(historyStack.length > 5) historyStack.shift();
        historyStack.push(JSON.parse(JSON.stringify(game)));
    }

    window.undoLastAction = async () => {
        if(historyStack.length === 0) { alert("ë˜ëŒë¦´ ê¸°ë¡ì´ ì—†ìŠµë‹ˆë‹¤."); return; }
        game = historyStack.pop();
        await update(ref(db, 'status'), game);
        const logsRef = ref(db, 'logs');
        get(query(logsRef, orderByKey(), limitToLast(1))).then((s) => { s.forEach((c) => remove(c.ref)); });
        alert("ë³µêµ¬ë¨!"); render();
    };

    async function loadSchedule() {
       try {
          const res = await fetch('schedule.json?t='+Date.now());
          const data = await res.json();
          const now = new Date();
          const target1 = `${String(now.getMonth()+1).padStart(2,'0')}.${String(now.getDate()).padStart(2,'0')}`;
          const target2 = `${String(now.getMonth()+1).padStart(2,'0')}-${String(now.getDate()).padStart(2,'0')}`;
          
          let found = null;
          Object.values(data).flat().forEach(g => { if(g.date.includes(target1) || g.date.includes(target2)) found = g; });

          if(found) {
             alert(`ê²½ê¸° ë°œê²¬! ${found.opponent}`);
             document.getElementById('homeName').value = found.opponent;
             if(found.location && (found.location.includes('ì²­ì£¼')||found.location.includes('ë³¸êµ'))) {
                document.querySelectorAll('input[name="firstAttack"]')[1].checked = true; 
                document.getElementById('homeName').value = 'TAURUS'; document.getElementById('awayName').value = found.opponent;
             }
          } else alert('ì˜¤ëŠ˜ ë‚ ì§œ ê²½ê¸°ê°€ ì—†ìŠµë‹ˆë‹¤. (ì§ì ‘ ì…ë ¥)');
       } catch(e) { alert('ìŠ¤ì¼€ì¤„ ë¡œë“œ ì˜¤ë¥˜: '+e.message); }
    }

    async function startGame() {
       try {
           const away = document.getElementById('awayName').value;
           const home = document.getElementById('homeName').value;
           const top = document.querySelector('input[name="firstAttack"]:checked').value === 'away';
           
           // ë¼ì¸ì—… ì½ê¸° (ì‹œì¦Œ ê¸°ë¡ í¬í•¨)
           const getL = (p) => {
              let a=[]; for(let i=0;i<9;i++) {
                  const name = document.getElementById(`${p}_n_${i}`)?.value || `íƒ€ì${i+1}`;
                  const avg = document.getElementById(`${p}_avg_${i}`)?.value || '0.000';
                  const ops = document.getElementById(`${p}_ops_${i}`)?.value || '0.000';
                  a.push({ name, avg, ops, pa:0, ab:0, h:0, bb:0, k:0, rbi:0, r:0 });
              } return a;
           };
           game = {
              teams: { away, home }, inn: '1íšŒì´ˆ', top, score: { away:0, home:0 }, bso: {b:0,s:0,o:0}, runner: {b1:false,b2:false,b3:false},
              lineups: { away: getL('a'), home: getL('h') },
              pitchers: { away:{ name:document.getElementById('awayPitcher').value||'ì›ì •íˆ¬ìˆ˜', total:0,s:0,b:0,k:0 }, home:{ name:document.getElementById('homePitcher').value||'í™ˆíˆ¬ìˆ˜', total:0,s:0,b:0,k:0 } },
              idx: { away:0, home:0 }, pitchCountForBatter: 0, lastPlay: ''
           };
           log(`=== ${game.inn} ì‹œì‘ ===`); logNewBatter(); await sync();
           document.getElementById('setupView').style.display='none'; document.getElementById('gameView').style.display='block';
       } catch(err) { alert("ì˜¤ë¥˜: "+err.message); }
    }

    window.sendPitch = (type) => {
       saveState();
       const def = game.top ? 'home' : 'away'; const p = game.pitchers[def];
       game.pitchCountForBatter++; p.total++;
       let txt = "";
       if(type==='b') { game.bso.b++; p.b++; txt="ë³¼"; if(game.bso.b>=4) openScenario('4ball','bb', true); }
       else if(type==='s') { game.bso.s++; p.s++; txt="ìŠ¤íŠ¸ë¼ì´í¬"; if(game.bso.s>=3) openScenario('k','so', true); }
       else if(type==='swing') { game.bso.s++; p.s++; txt="í—›ìŠ¤ìœ™"; if(game.bso.s>=3) openScenario('k','so', true); }
       else { if(game.bso.s<2) game.bso.s++; p.s++; txt="íŒŒìš¸"; }
       
       if(txt) {
           const atk = game.top ? 'away' : 'home';
           const batName = game.lineups[atk][game.idx[atk]].name;
           log(`${game.pitchCountForBatter}êµ¬ ${txt}`, batName);
       }
       game.lastPlay = txt; sync();
    };
    window.resetBSO = () => { saveState(); game.bso={b:0,s:0,o:game.bso.o}; game.lastPlay="ë¦¬ì…‹"; sync(); };

    window.openScenario = (type, detail, isAuto) => {
       document.getElementById('scenarioModal').style.display='flex';
       temp = { type, detail, runs:0, runners:[game.runner.b1, game.runner.b2, game.runner.b3], loc:'ì¤‘ì „', isAuto: isAuto };
       
       document.getElementById('hitLocBox').style.display = 'none';
       document.getElementById('hitLocBox_multi').style.display = 'none';
       
       if(type==='hit' && detail===1) { // 1ë£¨íƒ€,ì‹¤ì±…
           document.getElementById('hitLocBox').style.display = 'flex'; temp.loc='ì¤‘ì „';
       } else if(type==='err') {
           document.getElementById('hitLocBox').style.display = 'flex'; temp.loc='ì‹¤ì±…';
       } else if(type==='hit' || type==='hr') { // ì¥íƒ€
           document.getElementById('hitLocBox_multi').style.display = 'flex'; temp.loc='ì¤‘ì›”';
       }

       if(detail===4) { let r=1; if(game.runner.b1)r++; if(game.runner.b2)r++; if(game.runner.b3)r++; temp.runs=r; temp.runners=[false,false,false]; }
       updateModal();
    };
    function updateModal() {
       setText('scoreInput', temp.runs);
       document.getElementById('chk1').className = 'base-chk bc-1 '+(temp.runners[0]?'checked':'');
       document.getElementById('chk2').className = 'base-chk bc-2 '+(temp.runners[1]?'checked':'');
       document.getElementById('chk3').className = 'base-chk bc-3 '+(temp.runners[2]?'checked':'');
    }
    window.toggleBase=(i)=>{temp.runners[i-1]=!temp.runners[i-1];updateModal();}; window.adjScore=(n)=>{temp.runs+=n;if(temp.runs<0)temp.runs=0;updateModal();}; window.selLoc=(e,l)=>{document.querySelectorAll('.opt-btn').forEach(b=>b.classList.remove('selected'));e.classList.add('selected');temp.loc=l;};
    window.closeScenario=()=>document.getElementById('scenarioModal').style.display='none';

    window.submitScenario = () => {
       saveState();
       const atk = game.top ? 'away' : 'home'; const def = game.top ? 'home' : 'away';
       const bat = game.lineups[atk][game.idx[atk]]; const pit = game.pitchers[def];
       
       // íˆ¬êµ¬ìˆ˜ ìë™ ì¶”ê°€ (íƒ€ê²©/ì‚¼ì§„/ë³¼ë„·ì¼ ë•Œ, ìë™íŒì—… ì•„ë‹ê²½ìš°)
       if(['hit','hr','out','err','etc'].includes(temp.type)) {
           if(!temp.isAuto) { pit.total++; pit.s++; game.pitchCountForBatter++; }
       } else if (temp.type === 'k' && !temp.isAuto) {
           pit.total++; pit.s++; game.pitchCountForBatter++;
       } else if (temp.type === '4ball' && !temp.isAuto) {
           pit.total++; pit.b++; game.pitchCountForBatter++;
       }

       // ê¸°ë¡
       bat.pa++;
       if(['hit','hr','out','err','etc','k'].includes(temp.type)) bat.ab++;
       if(temp.type==='hit'||temp.type==='hr') bat.h++;
       if(temp.type==='4ball') bat.bb++;
       if(temp.type==='k') { bat.k++; pit.k++; }
       bat.rbi += temp.runs;
       
       if(temp.runs>0) { if(game.top) game.score.away+=temp.runs; else game.score.home+=temp.runs; }
       
       game.runner.b1 = temp.runners[0]; game.runner.b2 = temp.runners[1]; game.runner.b3 = temp.runners[2];
       
       if(temp.type==='out' && temp.detail==='dp') game.bso.o += 2;
       else if(temp.type==='out' || temp.type==='k') game.bso.o++;
       
       let logPrefix = `${game.pitchCountForBatter}êµ¬`;
       let isBatting = ['hit','hr','out','err','etc'].includes(temp.type);
       
       if(isBatting) logPrefix += ` íƒ€ê²© â–¶`; 
       else if(temp.type==='sb'||temp.type==='adv') logPrefix = `[ì£¼ì í”Œë ˆì´] â–¶`;
       else logPrefix += ` â–¶`;

       let txt = "";
       if(temp.type==='hit') txt = `${temp.loc} ì•ˆíƒ€`;
       else if(temp.detail===2) txt = `${temp.loc} 2ë£¨íƒ€`;
       else if(temp.detail===3) txt = `${temp.loc} 3ë£¨íƒ€`;
       else if(temp.detail===4) txt = `í™ˆëŸ°!!!!`;
       else if(temp.type==='k') txt = `ì‚¼ì§„ ì•„ì›ƒ`;
       else if(temp.type==='4ball') txt = (temp.detail==='hbp'?'ì‚¬êµ¬(ëª¸ë§ê³µ)':'ë³¼ë„· ì¶œë£¨');
       else if(temp.type==='out') txt = (temp.detail==='dp'?'ë³‘ì‚´íƒ€':(temp.detail==='go'?'ë•…ë³¼ ì•„ì›ƒ':'ëœ¬ê³µ ì•„ì›ƒ'));
       else if(temp.type==='sb') txt = `ë„ë£¨ ì„±ê³µ`;
       else if(temp.type==='adv') txt = `í­íˆ¬/í¬ì¼ ì§„ë£¨`;
       else txt = `ì‹¤ì±…/ì•¼ì„ `;
       
       if(temp.runs > 0) txt += ` (+${temp.runs}ë“ì )`;
       log(`${logPrefix} ${txt}`, bat.name);
       game.lastPlay = txt;

       if(temp.type !== 'sb' && temp.type !== 'adv') {
          if(game.bso.o >= 3) { alert('3ì•„ì›ƒ! ê³µìˆ˜êµëŒ€'); game.idx[atk]=(game.idx[atk]+1)%9; changeInn(); }
          else { game.idx[atk]=(game.idx[atk]+1)%9; game.bso.b=0; game.bso.s=0; logNewBatter(); }
       }
       sync(); closeScenario();
    };

    function changeInn() {
       let n = parseInt(game.inn);
       if(game.top) { game.inn=`${n}íšŒë§`; game.top=false; } else { game.inn=`${n+1}íšŒì´ˆ`; game.top=true; }
       game.bso={b:0,s:0,o:0}; game.runner={b1:false,b2:false,b3:false};
       log(`=== ${game.inn} ì‹œì‘ ===`); logNewBatter();
    }
    function logNewBatter() {
       game.pitchCountForBatter = 0; const atk = game.top ? 'away' : 'home'; const b = game.lineups[atk][game.idx[atk]];
       // ì‹œì¦Œ íƒ€ìœ¨/OPS ì‚¬ìš© (ì—†ìœ¼ë©´ - í‘œì‹œ)
       let info = `íƒ€ìœ¨ ${b.avg || '-'} OPS ${b.ops || '-'}`;
       log(`[${game.idx[atk]+1}ë²ˆ íƒ€ì ${b.name}] (${info})`, b.name);
    }

    async function sync() { await update(ref(db, 'status'), game); render(); }
    function log(m, batterName) { push(ref(db, 'logs'), { text:m, time:new Date().toLocaleTimeString('ko-KR',{hour:'2-digit',minute:'2-digit'}), batter: batterName||'System', notice:false }); }
    
    function render() {
       setText('s_away', game.score.away); setText('s_home', game.score.home);
       setText('d_away', game.teams.away); setText('d_home', game.teams.home);
       setText('d_inn', game.inn);
       setText('cnt_b', game.bso.b); setText('cnt_s', game.bso.s); setText('cnt_o', game.bso.o);
       
       const def = game.top?'home':'away'; const pit = game.pitchers[def];
       setText('cur_pit', pit.name); setText('pit_t', pit.total);
       setText('pit_s', pit.s); setText('pit_b', pit.b);

       const atk = game.top?'away':'home'; const bat = game.lineups[atk][game.idx[atk]];
       setText('cur_bat', `${game.idx[atk]+1}ë²ˆ ${bat.name}`);
       setText('cur_avg', `(íƒ€ìœ¨ ${bat.avg||'-'})`);
    }
    
    onValue(ref(db, 'status'), (s)=>{ if(s.val()){ game=s.val(); render(); if(document.getElementById('setupView').style.display!=='none'){document.getElementById('setupView').style.display='none'; document.getElementById('gameView').style.display='block';}}});
    
    window.changeBatter = ()=>{ saveState(); const atk=game.top?'away':'home'; const n=prompt('ëŒ€íƒ€'); if(n){game.lineups[atk][game.idx[atk]].name=n; log(`ëŒ€íƒ€ ${n}`); sync();} };
    window.changePitcher = ()=>{ saveState(); const def=game.top?'home':'away'; const n=prompt('íˆ¬ìˆ˜êµì²´'); if(n){game.pitchers[def]={name:n,total:0,s:0,b:0,k:0}; log(`íˆ¬ìˆ˜êµì²´ ${n}`); sync();} };
    window.endGame = ()=>{ const r={date:new Date().toLocaleDateString(), opponent:game.teams.home==='TAURUS'?game.teams.away:game.teams.home, score:`${game.score.away}:${game.score.home}`, result:'ì¢…ë£Œ'}; prompt('schedule.json ë³µì‚¬:', JSON.stringify(r)); };
    window.resetGame = () => { if(confirm("ì •ë§ ì´ˆê¸°í™”?")) { set(ref(db, 'status'), null); set(ref(db, 'logs'), null); location.reload(); } };
  </script>
</body>
</html>