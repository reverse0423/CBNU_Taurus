<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>TAURUS PRO RECORDER (REAL BASEBALL)</title>
  <link rel="stylesheet" href="style.css">
  <style>
    /* ê¸°ì¡´ ìŠ¤íƒ€ì¼ ìœ ì§€ */
    .pitch-pad { display: grid; grid-template-columns: repeat(4, 1fr); gap: 6px; margin-bottom: 12px; }
    .pitch-btn { padding: 12px 4px; border-radius: 8px; font-weight: bold; border: 1px solid #ccc; cursor: pointer; }
    .pb-s { background: #fff59d; color: #f57f17; }
    .pb-b { background: #e0f2f1; color: #00695c; }
    .pb-f { background: #eceff1; color: #546e7a; }
    .info-panel { background: #222; color: #fff; padding: 12px; border-radius: 8px; margin-bottom: 10px; font-size: 14px; }
    .info-row { display: flex; justify-content: space-between; margin-bottom: 6px; }
    .pitch-log-display { background: #333; padding: 8px; border-radius: 4px; font-size: 13px; color: #ffeb3b; margin-top: 5px; min-height: 24px; font-family: monospace; }
    .sub-controls { display: flex; gap: 5px; margin-top: 15px; border-top: 1px solid #ddd; padding-top: 10px; }
    .sub-btn { flex: 1; padding: 8px; background: #555; color: #fff; border: none; border-radius: 4px; font-size: 12px; cursor: pointer; }
    .team-col { flex: 1; min-width: 140px; }
    .setup-cols { display: flex; gap: 10px; margin-top: 10px; }
    
    /* ë² ì´ìŠ¤ ìˆ˜ì • ë²„íŠ¼ */
    .runner-edit-btn { position: absolute; bottom: 5px; right: 5px; font-size: 10px; background: #444; color:#fff; padding:2px 5px; border-radius:4px; cursor:pointer; }

    #matchListArea { margin-bottom: 20px; }
    .match-select-card { background: #fff; border: 1px solid #ddd; border-radius: 8px; padding: 15px; margin-bottom: 10px; cursor: pointer; display: flex; justify-content: space-between; align-items: center; }
    .m-btn { background: var(--primary); color: #fff; padding: 6px 12px; border-radius: 20px; font-size: 12px; border: none; }
    .skip-btn { width: 100%; padding: 10px; background: #eee; border: none; border-radius: 8px; cursor: pointer; }
  </style>
</head>
<body style="background:#f0f0f0;">

  <div id="loginLayer" class="admin-login-overlay">
    <h2>âš¾ TAURUS PRO</h2>
    <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸" style="padding:12px; margin:10px; text-align:center;">
    <button id="loginBtn" style="padding:10px 30px; font-weight:bold;">ENTER</button>
  </div>

  <main id="adminPanel" class="admin-panel">
    <div id="selectMatchSection" class="setup-box">
      <h3>ğŸ“… ê²½ê¸° ì„ íƒ</h3>
      <div id="matchListArea"><p style="text-align:center;">ìŠ¤ì¼€ì¤„ ë¡œë”©ì¤‘...</p></div>
      <button class="skip-btn" id="skipMatchBtn">ì§ì ‘ ì…ë ¥í•˜ê¸°</button>
    </div>

    <div id="setupSection" class="setup-box" style="display:none;">
      <h3>ğŸ› ï¸ ë¼ì¸ì—… ì„¤ì •</h3>
      <p id="selectedMatchInfo" style="color:green; font-weight:bold; font-size:12px; margin-bottom:5px;"></p>
      <div style="margin-bottom:10px; font-size:14px;">
        <label><input type="radio" name="homeAway" value="away" id="radioAway" checked> <b>íƒ€ìš°ë£¨ìŠ¤ ì›ì • (ì„ ê³µ)</b></label>
        <label><input type="radio" name="homeAway" value="home" id="radioHome" style="margin-left:15px;"> <b>íƒ€ìš°ë£¨ìŠ¤ í™ˆ (í›„ê³µ)</b></label>
      </div>
      <div class="setup-cols">
        <div class="team-col">
          <input type="text" id="setupAwayName" placeholder="ì›ì •íŒ€" value="TAURUS" style="width:100%; text-align:center; font-weight:bold; margin-bottom:5px;">
          <input type="text" id="startPitcherAway" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; margin-bottom:5px; background:#e3f2fd;">
          <div id="awayLineupGrid"></div>
        </div>
        <div class="team-col">
          <input type="text" id="setupHomeName" placeholder="í™ˆíŒ€" style="width:100%; text-align:center; font-weight:bold; margin-bottom:5px;">
          <input type="text" id="startPitcherHome" placeholder="ì„ ë°œíˆ¬ìˆ˜" style="width:100%; margin-bottom:5px; background:#e3f2fd;">
          <div id="homeLineupGrid"></div>
        </div>
      </div>
      <button id="startGameBtn" class="send-btn" style="background:#333; margin-top:15px;">PLAY BALL!</button>
    </div>

    <div id="gameSection" style="display:none;">
      <div class="live-scoreboard" style="margin:0 0 10px 0; border-radius:12px; padding:10px;">
        <div class="live-score-box">
          <div class="live-team">AWAY<br><span id="dispAway" style="font-size:14px;"></span></div>
          <div class="live-score"><span id="scAway">0</span>:<span id="scHome">0</span></div>
          <div class="live-team">HOME<br><span id="dispHome" style="font-size:14px;"></span></div>
        </div>
        <div style="margin-top:5px;">
           <button id="btnPrevInn">â—€</button>
           <span id="inningVal" style="margin:0 10px; font-weight:bold;">1íšŒì´ˆ</span>
           <button id="btnNextInn">â–¶</button>
        </div>
      </div>

      <div class="info-panel">
        <div class="info-row" style="border-bottom:1px solid #444; padding-bottom:6px;">
          <span id="currentBatterInfo" style="color:#ffeb3b; font-weight:bold; font-size:16px;">íƒ€ì„: -</span>
          <span id="currentBatterStat" style="color:#aaa; font-size:12px;"></span>
        </div>
        <div class="info-row">
          <span>ë§ˆìš´ë“œ: <span id="currentPitcherName">-</span></span>
          <span class="pitcher-stat">íˆ¬êµ¬ìˆ˜: <span id="pitchCountTotal">0</span> (S:<span id="pitchCountS">0</span> B:<span id="pitchCountB">0</span>)</span>
        </div>
        <div id="pitchHistoryDisp" class="pitch-log-display">ëŒ€ê¸° ì¤‘...</div>
      </div>

      <div class="control-group" style="padding:10px; position:relative;">
        <div class="runner-control" style="height:100px;">
           <div id="base3" class="base-plate bp-3" data-base="b3" style="top:35px;"><span>3</span></div>
           <div id="base2" class="base-plate bp-2" data-base="b2" style="top:5px;"><span>2</span></div>
           <div id="base1" class="base-plate bp-1" data-base="b1" style="top:35px;"><span>1</span></div>
        </div>
        <div style="text-align:center; font-weight:bold; margin-top:5px; font-size:18px;">
           <span style="color:green">B</span> <span id="dispB">0</span> &nbsp;
           <span style="color:#fbc02d">S</span> <span id="dispS">0</span> &nbsp;
           <span style="color:red">O</span> <span id="dispO">0</span>
        </div>
        <div class="runner-edit-btn" onclick="manualEditRunners()">ğŸ› ï¸ ì£¼ì/ì ìˆ˜ ê°•ì œìˆ˜ì •</div>
      </div>

      <div class="control-group">
        <h4 style="margin:0 0 5px; font-size:13px; color:#555;">âš¾ íˆ¬êµ¬ ì…ë ¥</h4>
        <div class="pitch-pad">
          <button class="pitch-btn pb-s" data-pitch="look">ë£¨í‚¹S</button>
          <button class="pitch-btn pb-s" data-pitch="swing">í—›ìŠ¤ìœ™</button>
          <button class="pitch-btn pb-f" data-pitch="foul">íŒŒìš¸</button>
          <button class="pitch-btn pb-b" data-pitch="ball">ë³¼</button>
        </div>
        <h4 style="margin:10px 0 5px; font-size:13px; color:#555;">ğŸ’¥ íƒ€ê²© ê²°ê³¼</h4>
        <div class="action-pad" style="grid-template-columns: repeat(4, 1fr);">
          <button class="act-btn act-hit" data-act="1b">ì•ˆíƒ€</button>
          <button class="act-btn act-hit" data-act="2b">2ë£¨íƒ€</button>
          <button class="act-btn act-hit" data-act="3b">3ë£¨íƒ€</button>
          <button class="act-btn act-hit" data-act="hr">í™ˆëŸ°</button>
          <button class="act-btn act-out" data-act="gnd_menu">ë•…ë³¼</button>
          <button class="act-btn act-out" data-act="fly_menu">ëœ¬ê³µ</button>
          <button class="act-btn act-out" data-act="k_menu">ì‚¼ì§„</button>
          <button class="act-btn act-out" data-act="fc_menu">ì•¼ì„ </button>
          <button class="act-btn act-base" data-act="bb_menu">ì‚¬ì‚¬êµ¬</button>
          <button class="act-btn act-adv" data-act="err_menu">ì‹¤ì±…</button>
          <button class="act-btn" style="background:#555; color:#fff;" data-act="inf_hit">ë‚´ì•¼ì•ˆíƒ€</button>
        </div>
        <div class="sub-controls">
           <button class="sub-btn" onclick="window.changeCurrentBatter()">ğŸ”„ ëŒ€íƒ€</button>
           <button class="sub-btn" onclick="window.changeCurrentPitcher()">âš¾ íˆ¬ìˆ˜êµì²´</button>
           <button class="sub-btn" onclick="window.sendManualTextFn()">ğŸ’¬ í…ìŠ¤íŠ¸</button>
        </div>
      </div>

      <div style="margin-top:10px; display:none;" id="manualInputBox">
        <textarea id="comment" rows="2" class="control-input" placeholder="ë‚´ìš©..."></textarea>
      </div>
      <div style="margin-top:20px; text-align:center;">
         <button id="resetGameBtn" style="background:#ddd; color:#333; border:none; padding:6px; font-size:11px;">âš ï¸ ì´ˆê¸°í™”</button>
      </div>
    </div>
  </main>

  <div id="actionModal" class="action-modal" style="display:none;">
     <div class="am-content"><h3 id="amTitle">ìƒì„¸</h3><div id="amButtons" class="am-btn-group"></div><button id="closeModalBtn" style="margin-top:15px; width:100%; padding:10px;">ë‹«ê¸°</button></div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMVkogwvzoQon3lo0_hiVewfoXxmvbYMU",
      authDomain: "taurus-cbnu.firebaseapp.com",
      databaseURL: "https://taurus-cbnu-default-rtdb.firebaseio.com",
      projectId: "taurus-cbnu",
      storageBucket: "taurus-cbnu.firebasestorage.app",
      messagingSenderId: "598393475132",
      appId: "1:598393475132:web:b266ef01509e6c20dd7339"
    };

    let app, db;
    try { app = initializeApp(firebaseConfig); db = getDatabase(app); } catch (e) { console.error(e); }

    let gameState = {
        teams: { away: 'TAURUS', home: 'ìƒëŒ€íŒ€' }, inningStr: '1íšŒì´ˆ', isTop: true,
        score: { away: 0, home: 0 }, bso: { b:0, s:0, o:0 }, runners: { b1: null, b2: null, b3: null },
        lineups: { away: [], home: [] }, pitchers: { away: {name:'',total:0,s:0,b:0}, home: {name:'',total:0,s:0,b:0} },
        batIdx: { away: 0, home: 0 }, currentPitchLog: []
    };

    document.addEventListener('DOMContentLoaded', () => {
        createLineupInputs('awayLineupGrid', 'awayP'); createLineupInputs('homeLineupGrid', 'homeP');
        bindEvent('loginBtn', 'click', handleLogin); bindEvent('adminPw', 'keypress', (e)=>{if(e.key==='Enter')handleLogin();});
        bindEvent('startGameBtn', 'click', startGame); bindEvent('skipMatchBtn', 'click', ()=>showSetupScreen());
        bindEvent('btnPrevInn', 'click', ()=>changeInning(-1)); bindEvent('btnNextInn', 'click', ()=>changeInning(1));
        bindEvent('resetGameBtn', 'click', resetGame); bindEvent('closeModalBtn', 'click', closeModal);
        document.querySelectorAll('.pitch-btn').forEach(b=>b.addEventListener('click', (e)=>handlePitch(e.target.dataset.pitch)));
        document.querySelectorAll('.act-btn').forEach(b=>b.addEventListener('click', (e)=>handleAction(e.target.dataset.act)));
        document.querySelectorAll('.base-plate').forEach(b=>b.addEventListener('click', ()=>handleBaseClick(b.dataset.base)));
        loadScheduledMatches();
    });

    async function loadScheduledMatches() {
        const area = document.getElementById('matchListArea');
        try {
            const res = await fetch('schedule.json?t='+Date.now()); if(!res.ok) throw new Error("X");
            const data = await res.json();
            let matches = [];
            Object.keys(data).forEach(y => { if(Array.isArray(data[y])) data[y].forEach(g => { if(g.result==='ì˜ˆì •') matches.push({...g}); }); });
            if(matches.length===0) area.innerHTML = '<p style="text-align:center;">ì˜ˆì • ê²½ê¸° ì—†ìŒ</p>';
            else {
                area.innerHTML = '';
                matches.forEach(m => {
                    const d = document.createElement('div'); d.className='match-select-card';
                    d.innerHTML = `<div><span class="m-id">${m.date} ${m.time}</span><div class="m-vs">vs ${m.opponent}</div></div><button class="m-btn">ì„ íƒ</button>`;
                    d.onclick = () => {
                        const loc = m.location||""; const isHome = (loc.includes('ì²­ì£¼')||loc.includes('ë³¸êµ')||loc.includes('ì²­ì›'));
                        if(isHome) { document.getElementById('radioHome').checked=true; document.getElementById('setupHomeName').value="TAURUS"; document.getElementById('setupAwayName').value=m.opponent; }
                        else { document.getElementById('radioAway').checked=true; document.getElementById('setupAwayName').value="TAURUS"; document.getElementById('setupHomeName').value=m.opponent; }
                        document.getElementById('selectedMatchInfo').textContent=`ì„ íƒ: ${m.date} vs ${m.opponent}`; showSetupScreen();
                    };
                    area.appendChild(d);
                });
            }
        } catch(e) { area.innerHTML = '<p style="text-align:center;">ìŠ¤ì¼€ì¤„ ë¡œë“œ ì‹¤íŒ¨</p>'; }
    }

    function showSetupScreen() { document.getElementById('selectMatchSection').style.display='none'; document.getElementById('setupSection').style.display='block'; }
    function createLineupInputs(id, pfix) { const g=document.getElementById(id); if(g) { g.innerHTML=''; for(let i=0;i<9;i++) g.innerHTML+=`<div class="lineup-row" style="margin-bottom:2px;"><span class="pos-badge">${i+1}</span><input type="text" id="${pfix}${i}" style="width:90px; padding:4px;"></div>`; } }
    function bindEvent(id, type, h) { const e=document.getElementById(id); if(e) e.addEventListener(type, h); }
    function handleLogin() { if(document.getElementById('adminPw').value==='taurus') { document.getElementById('loginLayer').style.display='none'; document.getElementById('adminPanel').style.display='block'; } else alert('PW?'); }

    async function startGame() {
        if(!db) return alert("DBì—°ê²° ì‹¤íŒ¨");
        const freshState = {
            teams:{away:'',home:''}, inningStr:'1íšŒì´ˆ', isTop:true, score:{away:0,home:0}, bso:{b:0,s:0,o:0}, runners:{b1:null,b2:null,b3:null},
            lineups:{away:[],home:[]}, pitchers:{away:{name:'',total:0,s:0,b:0}, home:{name:'',total:0,s:0,b:0}}, batIdx:{away:0,home:0}, currentPitchLog:[]
        };
        const isHome = document.querySelector('input[name="homeAway"]:checked').value === 'home';
        freshState.isTop = !isHome; 
        freshState.teams.away = document.getElementById('setupAwayName').value;
        freshState.teams.home = document.getElementById('setupHomeName').value;
        freshState.pitchers.away.name = document.getElementById('startPitcherAway').value;
        freshState.pitchers.home.name = document.getElementById('startPitcherHome').value;
        freshState.lineups.away = readLineupInputs('awayP');
        freshState.lineups.home = readLineupInputs('homeP');
        
        gameState = freshState;
        await set(ref(db, 'status'), gameState);
        document.getElementById('setupSection').style.display='none'; document.getElementById('gameSection').style.display='block'; renderBoard();
    }
    function readLineupInputs(p) { let a=[]; for(let i=0;i<9;i++) a.push({name:document.getElementById(p+i).value||`íƒ€ì${i+1}`, ab:0, h:0, rbi:0, bb:0, k:0}); return a; }

    async function handlePitch(type) {
        if(!gameState.currentPitchLog) gameState.currentPitchLog=[];
        if(!gameState.pitchers) return;
        const def = gameState.isTop?'home':'away';
        const p = gameState.pitchers[def];
        p.total++;
        
        let pitchName = "";
        if(type==='ball') { 
            p.b++; gameState.bso.b++; pitchName="ë³¼"; 
            if(gameState.bso.b>=4) { gameState.currentPitchLog.push(pitchName); processPlay('bb'); return; }
        } else {
            p.s++; 
            if(type!=='foul' || gameState.bso.s<2) gameState.bso.s++;
            if(type==='look') pitchName="ìŠ¤íŠ¸ë¼ì´í¬";
            else if(type==='swing') pitchName="í—›ìŠ¤ìœ™";
            else if(type==='foul') pitchName="íŒŒìš¸";
            
            if(gameState.bso.s>=3) { gameState.currentPitchLog.push(pitchName); processPlay(type==='look'?'k_look':'k_swing'); return; }
        }
        gameState.currentPitchLog.push(pitchName);
        await syncAll(); renderBoard();
    }

    function handleAction(act) { if(act.includes('_menu')) openModal(act); else processPlay(act); }

    // === í•µì‹¬ ë¡œì§ ìˆ˜ì • (í™ˆëŸ° ë° ìœ ë™ì  ì§„ë£¨) ===
    async function processPlay(code) {
        if(!gameState.currentPitchLog) gameState.currentPitchLog=[];
        
        const atk = gameState.isTop?'away':'home';
        const def = gameState.isTop?'home':'away';
        const batter = gameState.lineups[atk][gameState.batIdx[atk]];
        const pitcher = gameState.pitchers[def];

        if(!['bb','k_look','k_swing','not_out','hbp'].includes(code)) {
            pitcher.total++; pitcher.s++; gameState.currentPitchLog.push('íƒ€ê²©');
        }

        let resultTxt = "";
        let runOutcome = null;

        // 1. í™ˆëŸ° (ì¦‰ì‹œ ì²˜ë¦¬, ë²„ê·¸ ìˆ˜ì •ë¨)
        if(code==='hr') { 
            batter.ab++; batter.h++; resultTxt='í™ˆëŸ°!!';
            // í™ˆëŸ° íƒ€ì  ê³„ì‚° (ì£¼ì ìˆ˜ + 1)
            let rbi = 1;
            if(gameState.runners.b1) rbi++;
            if(gameState.runners.b2) rbi++;
            if(gameState.runners.b3) rbi++;
            
            batter.rbi += rbi;
            batter.run++; // ë³¸ì¸ ë“ì 
            addScore(rbi); // íŒ€ ì ìˆ˜
            
            gameState.runners = {b1:null, b2:null, b3:null}; // ì£¼ì ì‚­ì œ
        }
        // 2. ì•ˆíƒ€/2ë£¨íƒ€/3ë£¨íƒ€ (ì£¼ì ìˆì„ ì‹œ ë¬¼ì–´ë´„)
        else if(['1b','2b','3b','inf_hit'].includes(code)) {
            batter.ab++; batter.h++;
            const hasRunner = gameState.runners.b1 || gameState.runners.b2 || gameState.runners.b3;
            
            if(code==='1b') resultTxt='ì¢Œì „ ì•ˆíƒ€';
            else if(code==='2b') resultTxt='2ë£¨íƒ€';
            else if(code==='3b') resultTxt='3ë£¨íƒ€';
            else resultTxt='ë‚´ì•¼ ì•ˆíƒ€';

            if(hasRunner) {
                // ì£¼ìê°€ ìˆìœ¼ë©´ ë¬¼ì–´ë³¸ë‹¤ (ìœ ë™ì  ìƒí™©)
                const scoredStr = prompt("ëª‡ ëª… ë“¤ì–´ì™”ìŠµë‹ˆê¹Œ? (ìˆ«ìë§Œ ì…ë ¥)", "0");
                const scored = parseInt(scoredStr || "0");
                
                // ì ìˆ˜ ë°˜ì˜
                if(scored > 0) {
                    addScore(scored);
                    batter.rbi += scored;
                }
                // ì£¼ì ìë™ ì¬ë°°ì¹˜ (ë‹¨ìˆœí™”: ë‚¨ì€ ì£¼ìëŠ” ì„ í–‰ë£¨ë¡œ)
                smartAdvance(code, scored, batter.name); 
            } else {
                // ì£¼ì ì—†ìœ¼ë©´ ë‹¨ìˆœ ì§„ë£¨
                simpleAdvance(code, batter.name);
            }
        }
        // 3. ê¸°íƒ€
        else if(code==='go') { batter.ab++; resultTxt='ë•…ë³¼ ì•„ì›ƒ'; addOut(); }
        else if(code==='fo') { batter.ab++; resultTxt='ëœ¬ê³µ ì•„ì›ƒ'; addOut(); }
        else if(code==='k_look') { batter.ab++; batter.k++; resultTxt='ë£¨í‚¹ ì‚¼ì§„'; addOut(); }
        else if(code==='k_swing') { batter.ab++; batter.k++; resultTxt='í—›ìŠ¤ìœ™ ì‚¼ì§„'; addOut(); }
        else if(code==='bb') { batter.bb++; resultTxt='ë³¼ë„· ì¶œë£¨'; pushRunners(); gameState.runners.b1=batter.name; }
        else if(code==='hbp') { batter.bb++; resultTxt='ì‚¬êµ¬ ì¶œë£¨'; pushRunners(); gameState.runners.b1=batter.name; }
        else if(code==='fc_safe') { batter.ab++; resultTxt='ì•¼ì„  ì¶œë£¨'; addOut(); if(gameState.runners.b1)gameState.runners.b1=null; gameState.runners.b1=batter.name; }
        else if(code==='dp') { batter.ab++; resultTxt='ë³‘ì‚´íƒ€'; addOut(); addOut(); if(gameState.runners.b1)gameState.runners.b1=null; }
        else if(code==='error_safe') { batter.ab++; resultTxt='ì‹¤ì±… ì¶œë£¨'; pushRunners(); gameState.runners.b1=batter.name; }

        // ë¡œê·¸ ìƒì„±
        let fullLog = "";
        if(gameState.currentPitchLog.length > 0) {
            fullLog = gameState.currentPitchLog.map((p,i)=>`${i+1}êµ¬ ${p}`).join(', ');
            fullLog += ` â–¶ ${resultTxt}`;
        } else { fullLog = resultTxt; }
        
        log(`[${gameState.batIdx[atk]+1}ë²ˆ ${batter.name}] ${fullLog}`);

        // ê³µìˆ˜êµëŒ€ ì²´í¬
        if(gameState.bso.o >= 3) {
            alert("3ì•„ì›ƒ! ê³µìˆ˜êµëŒ€");
            nextBatter(atk); // ì´ë²ˆ íƒ€ìëŠ” ëë‚¬ìœ¼ë‹ˆ ë‹¤ìŒ íƒ€ìˆœìœ¼ë¡œ
            changeInning(1);
        } else {
            nextBatter(atk);
            resetCount();
        }
        await syncAll(); renderBoard();
    }

    // === ìŠ¤ë§ˆíŠ¸ ì§„ë£¨ ë¡œì§ (ë“ì  ìˆ˜ì— ë”°ë¼ ë‚˜ë¨¸ì§€ ì£¼ì ë°°ì¹˜) ===
    function smartAdvance(hitType, scoredCount, batterName) {
        // ê¸°ì¡´ ì£¼ì ìƒíƒœ ë°±ì—…
        const oldRunners = {...gameState.runners};
        gameState.runners = {b1:null, b2:null, b3:null}; // ì¼ë‹¨ ë¹„ì›€

        // íƒ€ì ì£¼ì ìœ„ì¹˜ ì‹œí‚¤ê¸°
        if(hitType==='1b' || hitType==='inf_hit') gameState.runners.b1 = batterName;
        else if(hitType==='2b') gameState.runners.b2 = batterName;
        else if(hitType==='3b') gameState.runners.b3 = batterName;

        // ë‚¨ì€ ì£¼ì ë°°ì¹˜ (ì•Œê³ ë¦¬ì¦˜: ë“ì í•˜ê³  ë‚¨ì€ ì„ í–‰ì£¼ìë¥¼ ê°€ì¥ ì•ì„  ë² ì´ìŠ¤ë¶€í„° ì±„ì›€)
        // ì˜ˆë¥¼ ë“¤ì–´ 1,2ë£¨ì—ì„œ 2ë£¨íƒ€ ì¹˜ê³  1ì  ë‚¬ìœ¼ë©´ -> 2ë£¨ì£¼ì ë“ì , 1ë£¨ì£¼ìëŠ” 3ë£¨ì— ê°.
        // í•˜ì§€ë§Œ ê¸°ê³„ê°€ ì™„ë²½íˆ ì•Œ ìˆ˜ ì—†ìœ¼ë¯€ë¡œ, ì—¬ê¸°ì„œëŠ” "ë“ì  ì•ˆí•œ ì£¼ìëŠ” ê°€ì¥ ë¨¼ ë£¨ì— ê°”ë‹¤"ê³  ê°€ì •.
        // ë§Œì•½ ì´ê²Œ í‹€ë¦¬ë©´ 'ì£¼ì ê°•ì œìˆ˜ì •' ë²„íŠ¼ìœ¼ë¡œ ê³ ì¹˜ê²Œ ìœ ë„.
        
        let runnersOnBase = [];
        if(oldRunners.b3) runnersOnBase.push(oldRunners.b3);
        if(oldRunners.b2) runnersOnBase.push(oldRunners.b2);
        if(oldRunners.b1) runnersOnBase.push(oldRunners.b1);
        
        // ë“ì í•œ ìˆ˜ë§Œí¼ ì•ì—ì„œë¶€í„° ì œì™¸
        for(let i=0; i<scoredCount; i++) {
            runnersOnBase.shift(); 
        }

        // ë‚¨ì€ ì£¼ì ì¬ë°°ì¹˜ (3ë£¨ë¶€í„° ì±„ì›€)
        if(runnersOnBase.length > 0) {
            // íƒ€ìê°€ ì ìœ í•œ ë² ì´ìŠ¤ í”¼í•´ì„œ ë°°ì¹˜í•´ì•¼ í•¨.. ë³µì¡í•˜ì£ ?
            // ê°€ì¥ ê°„ë‹¨í•˜ê³  í™•ì‹¤í•œ ë°©ë²•:
            // "íƒ€ì ì™¸ ë‚¨ì€ ì£¼ìëŠ” 3ë£¨ -> 2ë£¨ ìˆœìœ¼ë¡œ ì±„ìš´ë‹¤" (ë‹¨, íƒ€ì ìœ„ì¹˜ ì œì™¸)
            
            // íƒ€ì ìœ„ì¹˜
            let batterBase = (hitType.includes('3b'))?3 : (hitType.includes('2b')?2 : 1);
            
            runnersOnBase.forEach(runner => {
                if(!gameState.runners.b3 && batterBase !== 3) gameState.runners.b3 = runner;
                else if(!gameState.runners.b2 && batterBase !== 2) gameState.runners.b2 = runner;
                else if(!gameState.runners.b1 && batterBase !== 1) gameState.runners.b1 = runner;
            });
        }
    }

    function simpleAdvance(code, name) {
        // ì£¼ì ì—†ì„ ë•Œ ë‹¨ìˆœ ì§„ë£¨
        if(code==='1b'||code==='inf_hit') gameState.runners.b1 = name;
        else if(code==='2b') gameState.runners.b2 = name;
        else if(code==='3b') gameState.runners.b3 = name;
    }

    function pushRunners(){
        if(!gameState.runners) gameState.runners={b1:null,b2:null,b3:null};
        let r=gameState.runners; const atk=gameState.isTop?'away':'home';
        if(r.b1){if(r.b2){if(r.b3){addScore(1);gameState.lineups[atk][gameState.batIdx[atk]].rbi++;}else r.b3=r.b2;}else r.b2=r.b1;}
    }
    function addOut(){ gameState.bso.o++; }
    function addScore(n){ if(gameState.isTop)gameState.score.away+=n; else gameState.score.home+=n; }
    function nextBatter(side){ gameState.batIdx[side]=(gameState.batIdx[side]+1)%9; }
    function resetCount(){ gameState.bso.b=0;gameState.bso.s=0;gameState.currentPitchLog=[]; }
    function changeInning(d){
        let n=parseInt(gameState.inningStr); 
        if(gameState.isTop) { gameState.inningStr=`${n}íšŒë§`; gameState.isTop=false; }
        else { gameState.inningStr=`${n+1}íšŒì´ˆ`; gameState.isTop=true; }
        gameState.bso={b:0,s:0,o:0}; gameState.runners={b1:null,b2:null,b3:null}; gameState.currentPitchLog=[];
        log(`=== ${gameState.inningStr} ì‹œì‘ ===`);
    }

    // ì „ì—­ í•¨ìˆ˜ë“¤
    window.changeCurrentBatter=()=>{const s=gameState.isTop?'away':'home';const i=gameState.batIdx[s];const n=prompt('ëŒ€íƒ€:',gameState.lineups[s][i].name);if(n){gameState.lineups[s][i].name=n;log(`[êµì²´] ëŒ€íƒ€ ${n}`);syncAll();renderBoard();}};
    window.changeCurrentPitcher=()=>{const s=gameState.isTop?'home':'away';const n=prompt('íˆ¬ìˆ˜êµì²´:',gameState.pitchers[s].name);if(n){gameState.pitchers[s]={name:n,total:0,s:0,b:0};log(`[êµì²´] íˆ¬ìˆ˜ ${n}`);syncAll();renderBoard();}};
    window.sendManualTextFn=()=>{const t=document.getElementById('comment').value;if(t){log(t);document.getElementById('comment').value='';}};
    window.handleBaseClick=(b)=>{if(!gameState.runners)gameState.runners={b1:null,b2:null,b3:null}; if(gameState.runners[b]){if(confirm('ì‚­ì œ?')){gameState.runners[b]=null;syncAll();renderBoard();}}else{const n=prompt('ì£¼ìëª…:');if(n){gameState.runners[b]=n;syncAll();renderBoard();}}};
    window.manualEditRunners = () => {
        const r1 = prompt("1ë£¨ ì£¼ì ì´ë¦„ (ì—†ìœ¼ë©´ ì—”í„°)", gameState.runners.b1||"");
        const r2 = prompt("2ë£¨ ì£¼ì ì´ë¦„ (ì—†ìœ¼ë©´ ì—”í„°)", gameState.runners.b2||"");
        const r3 = prompt("3ë£¨ ì£¼ì ì´ë¦„ (ì—†ìœ¼ë©´ ì—”í„°)", gameState.runners.b3||"");
        const scAway = prompt("ì›ì • ì ìˆ˜", gameState.score.away);
        const scHome = prompt("í™ˆ ì ìˆ˜", gameState.score.home);
        
        gameState.runners.b1 = r1 || null;
        gameState.runners.b2 = r2 || null;
        gameState.runners.b3 = r3 || null;
        gameState.score.away = parseInt(scAway);
        gameState.score.home = parseInt(scHome);
        syncAll(); renderBoard();
    };

    function openModal(act) { const m=document.getElementById('actionModal'); const b=document.getElementById('amButtons'); b.innerHTML=''; m.style.display='flex'; let btns=[]; if(act==='gnd_menu')btns=[{txt:'ë•…ë³¼',code:'go'},{txt:'ì•¼ì„ ',code:'fc_safe'},{txt:'ë³‘ì‚´',code:'dp'}]; else if(act==='fly_menu')btns=[{txt:'ëœ¬ê³µ',code:'fo'}]; else if(act==='k_menu')btns=[{txt:'í—›ìŠ¤ìœ™K',code:'k_swing'},{txt:'ë£¨í‚¹K',code:'k_look'}]; else if(act==='bb_menu')btns=[{txt:'ë³¼ë„·',code:'bb'},{txt:'ëª¸ë§ê³µ',code:'hbp'}]; else if(act==='err_menu')btns=[{txt:'ì‹¤ì±…',code:'error_safe'}]; btns.forEach(i=>{const btn=document.createElement('button');btn.className='am-btn';btn.textContent=i.txt;btn.onclick=()=>{processPlay(i.code);closeModal();};b.appendChild(btn);}); }
    function closeModal() { document.getElementById('actionModal').style.display='none'; }
    async function syncAll() { if(db) await update(ref(db, 'status'), gameState); }
    function log(msg) { if(db) push(ref(db, 'logs'), { text: msg, time: new Date().toLocaleTimeString('ko-KR', {hour:'2-digit',minute:'2-digit'}), notice: false }); }

    function renderBoard() {
        const g=gameState; if(!g.lineups)return;
        document.getElementById('scAway').textContent=g.score.away; document.getElementById('scHome').textContent=g.score.home;
        document.getElementById('dispAway').textContent=g.teams.away; document.getElementById('dispHome').textContent=g.teams.home;
        document.getElementById('inningVal').textContent=g.inningStr;
        document.getElementById('dispB').textContent=g.bso.b; document.getElementById('dispS').textContent=g.bso.s; document.getElementById('dispO').textContent=g.bso.o;
        ['b1','b2','b3'].forEach(k=>{const el=document.querySelector(`[data-base="${k}"]`); if(el){if(g.runners&&g.runners[k]){el.classList.add('active');el.title=g.runners[k];}else{el.classList.remove('active');el.title='';}}});
        
        const atk=g.isTop?'away':'home'; const bat=g.lineups[atk][g.batIdx[atk]];
        document.getElementById('currentBatterInfo').textContent=`íƒ€ì„: ${g.batIdx[atk]+1}ë²ˆ ${bat.name}`;
        document.getElementById('currentPitcherName').textContent=g.pitchers[g.isTop?'home':'away'].name;
        document.getElementById('pitchCountTotal').textContent=g.pitchers[g.isTop?'home':'away'].total;
        
        // íˆ¬êµ¬ ë¡œê·¸ ë¯¸ë¦¬ë³´ê¸°
        if(g.currentPitchLog && g.currentPitchLog.length>0) {
            document.getElementById('pitchHistoryDisp').textContent = g.currentPitchLog.join('  |  ');
        } else {
            document.getElementById('pitchHistoryDisp').textContent = "ì´ˆêµ¬ ëŒ€ê¸° ì¤‘...";
        }
    }
    
    onValue(ref(db, 'status'), (snap) => {
        const d=snap.val(); if(d){ gameState=d; if(!gameState.runners)gameState.runners={b1:null,b2:null,b3:null}; renderBoard(); }
    });
    function resetGame(){if(confirm("ì´ˆê¸°í™”?")){set(ref(db,'status'),null);set(ref(db,'logs'),null);location.reload();}}
  </script>
</body>
</html>