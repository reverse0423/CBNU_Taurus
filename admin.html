<!DOCTYPE html>
<html lang="ko">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ë¬¸ìì¤‘ê³„ ì»¨íŠ¸ë¡¤ íƒ€ì›Œ (Pro)</title>
  <link rel="stylesheet" href="style.css">
</head>
<body style="background:#f0f0f0;">

  <div id="loginLayer" class="admin-login-overlay">
    <h2>âš¾ TAURUS MANAGER</h2>
    <input type="password" id="adminPw" placeholder="ë¹„ë°€ë²ˆí˜¸ (taurus)" style="padding:12px; margin:10px; border-radius:8px; border:none; width:200px; text-align:center;">
    <button id="loginBtn" style="padding:10px 30px; border-radius:8px; cursor:pointer; font-weight:bold;">ENTER</button>
  </div>

  <main id="adminPanel" class="admin-panel">
    
    <div id="setupSection" class="setup-box">
      <h3>ğŸ› ï¸ ê²½ê¸° ì„¤ì • (Lineup)</h3>
      <div style="margin:10px 0;">
        <label><input type="radio" name="homeAway" value="away" checked> <b>íƒ€ìš°ë£¨ìŠ¤ ì›ì • (ì´ˆ)</b></label>
        <label><input type="radio" name="homeAway" value="home" style="margin-left:15px;"> <b>íƒ€ìš°ë£¨ìŠ¤ í™ˆ (ë§)</b></label>
      </div>
      <div class="lineup-grid" id="lineupInputs"></div>
      <div style="margin-top:10px;">
         <input type="text" id="oppName" placeholder="ìƒëŒ€íŒ€ ì´ë¦„" style="width:100%; padding:10px;">
      </div>
      <button id="startGameBtn" class="send-btn" style="background:#333; margin-top:15px;">ê²½ê¸° ì‹œì‘</button>
    </div>

    <div id="gameSection" style="display:none;">
      <div class="live-scoreboard" style="margin:0 0 10px 0; border-radius:12px; padding:10px;">
        <div class="live-score-box">
          <div class="live-team">AWAY<br><span id="dispAway" style="font-size:14px;"></span></div>
          <div class="live-score"><span id="scAway">0</span>:<span id="scHome">0</span></div>
          <div class="live-team">HOME<br><span id="dispHome" style="font-size:14px;"></span></div>
        </div>
        <div style="margin-top:5px;">
           <button id="btnPrevInn">â—€</button>
           <span id="inningVal" style="margin:0 10px; font-weight:bold;">1íšŒì´ˆ</span>
           <button id="btnNextInn">â–¶</button>
        </div>
      </div>

      <div class="control-group" style="padding:10px;">
        <div class="runner-control">
           <div id="base3" class="base-plate bp-3" data-base="b3"><span>3ë£¨</span></div>
           <div id="base2" class="base-plate bp-2" data-base="b2"><span>2ë£¨</span></div>
           <div id="base1" class="base-plate bp-1" data-base="b1"><span>1ë£¨</span></div>
           <div class="base-plate bp-h" style="border:none; background:none; color:#fff;"><span>Home</span></div>
        </div>
        <div style="text-align:center; display:flex; justify-content:space-around;">
           <div>B <input type="number" id="cntB" value="0" style="width:30px;"></div>
           <div>S <input type="number" id="cntS" value="0" style="width:30px;"></div>
           <div>O <input type="number" id="cntO" value="0" style="width:30px;"></div>
           <button id="resetCountBtn" style="padding:2px 8px;">ë¦¬ì…‹</button>
        </div>
      </div>

      <div class="control-group">
        <h4 id="currentBatterDisplay" style="text-align:center; color:var(--primary); margin:0 0 10px;">í˜„ì¬ íƒ€ì: -</h4>
        
        <div class="action-pad" style="grid-template-columns: repeat(4, 1fr);">
          <button class="act-btn act-hit" data-act="1b">1ë£¨íƒ€</button>
          <button class="act-btn act-hit" data-act="2b">2ë£¨íƒ€</button>
          <button class="act-btn act-hit" data-act="3b">3ë£¨íƒ€</button>
          <button class="act-btn act-hit" data-act="hr">í™ˆëŸ°</button>
          
          <button class="act-btn act-out" data-act="gnd_menu">ë•…ë³¼/ì•¼ì„ </button>
          <button class="act-btn act-out" data-act="fly_menu">ëœ¬ê³µ/ì§ì„ </button>
          <button class="act-btn act-out" data-act="k_menu">ì‚¼ì§„</button>
          <button class="act-btn act-out" data-act="sac_menu">í¬ìƒíƒ€</button>

          <button class="act-btn act-base" data-act="bb_menu">ì‚¬ì‚¬êµ¬</button>
          <button class="act-btn act-adv" data-act="err_menu">ì‹¤ì±…</button>
          <button class="act-btn act-adv" data-act="etc_menu">ë„ë£¨/í­íˆ¬</button>
          <button class="act-btn" style="background:#555; color:#fff;" data-act="inf_hit">ë‚´ì•¼ì•ˆíƒ€</button>
        </div>
      </div>

      <div class="box-score-wrap">
         <h4>ğŸ“Š íƒ€ìš°ë£¨ìŠ¤ íƒ€ì„ ê¸°ë¡</h4>
         <table class="bs-table">
            <thead><tr><th>íƒ€ìˆœ</th><th>ì´ë¦„</th><th>íƒ€ìˆ˜</th><th>ì•ˆíƒ€</th><th>íƒ€ì </th><th>ë“ì </th><th>ì‚¬êµ¬</th><th>ì‚¼ì§„</th></tr></thead>
            <tbody id="lineupTableBody"></tbody>
         </table>
      </div>

      <div class="control-group" style="margin-top:10px;">
        <textarea id="comment" rows="2" class="control-input" placeholder="ìˆ˜ë™ ì¤‘ê³„ ì…ë ¥..."></textarea>
        <button id="sendTextBtn" class="send-btn" style="margin-top:5px; padding:8px;">í…ìŠ¤íŠ¸ ì „ì†¡</button>
      </div>
      <div style="margin-top:30px; text-align:center;">
         <button id="resetGameBtn" style="background:#999; color:#fff; border:none; padding:8px; border-radius:4px; font-size:12px;">âš ï¸ ê²½ê¸° ì´ˆê¸°í™”</button>
      </div>
    </div>
  </main>

  <div id="actionModal" class="action-modal" style="display:none;">
     <div class="am-content">
        <h3 id="amTitle">ìƒì„¸ ì„ íƒ</h3>
        <div id="amButtons" class="am-btn-group"></div>
        <button id="closeModalBtn" style="margin-top:15px; width:100%; padding:10px;">ë‹«ê¸°</button>
     </div>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, set, push, update, onValue } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyDMVkogwvzoQon3lo0_hiVewfoXxmvbYMU",
      authDomain: "taurus-cbnu.firebaseapp.com",
      databaseURL: "https://taurus-cbnu-default-rtdb.firebaseio.com",
      projectId: "taurus-cbnu",
      storageBucket: "taurus-cbnu.firebasestorage.app",
      messagingSenderId: "598393475132",
      appId: "1:598393475132:web:b266ef01509e6c20dd7339"
    };

    let app, db;
    try {
        app = initializeApp(firebaseConfig);
        db = getDatabase(app);
    } catch (e) {
        console.error("Firebase Init Error:", e);
    }

    let gameState = {
        myTeam: 'away', oppName: 'ìƒëŒ€íŒ€', inningStr: '1íšŒì´ˆ',
        score: { away: 0, home: 0 },
        bso: { b:0, s:0, o:0 },
        runners: { b1: null, b2: null, b3: null },
        lineup: [], currentBatterIdx: 0
    };

    document.addEventListener('DOMContentLoaded', () => {
        const grid = document.getElementById('lineupInputs');
        if (grid) {
            grid.innerHTML = '';
            for(let i=0; i<9; i++) {
                grid.innerHTML += `
                    <div class="lineup-row">
                        <span class="pos-badge">${i+1}ë²ˆ</span>
                        <input type="text" id="pName${i}" class="lineup-name-input" placeholder="ì´ë¦„" style="width:100px; padding:6px;">
                    </div>`;
            }
        }

        bindEvent('loginBtn', 'click', handleLogin);
        bindEvent('adminPw', 'keypress', (e) => { if(e.key==='Enter') handleLogin(); });
        bindEvent('startGameBtn', 'click', startGame);
        bindEvent('btnPrevInn', 'click', () => changeInning(-1));
        bindEvent('btnNextInn', 'click', () => changeInning(1));
        bindEvent('resetCountBtn', 'click', () => { resetCount(); syncAll(); renderBoard(); });
        bindEvent('sendTextBtn', 'click', sendManualText);
        bindEvent('resetGameBtn', 'click', resetGame);
        bindEvent('closeModalBtn', 'click', closeModal);

        document.querySelectorAll('.act-btn').forEach(btn => {
            btn.addEventListener('click', (e) => handleAction(e.target.dataset.act));
        });

        document.querySelectorAll('.base-plate').forEach(plate => {
            plate.addEventListener('click', () => {
                const base = plate.dataset.base;
                if(!base) return;
                if(gameState.runners[base]) {
                    if(confirm("ì£¼ìë¥¼ ì§€ìš°ì‹œê² ìŠµë‹ˆê¹Œ?")) {
                        gameState.runners[base] = null;
                        syncAll(); renderBoard();
                    }
                } else {
                    const name = prompt("ì£¼ì ì´ë¦„ ì…ë ¥:");
                    if(name) {
                        gameState.runners[base] = name;
                        syncAll(); renderBoard();
                    }
                }
            });
        });
    });

    function bindEvent(id, type, handler) {
        const el = document.getElementById(id);
        if(el) el.addEventListener(type, handler);
    }

    function handleLogin() {
        const pw = document.getElementById('adminPw').value;
        if(pw === 'taurus') {
            document.getElementById('loginLayer').style.display = 'none';
            document.getElementById('adminPanel').style.display = 'block';
        } else alert('ë¹„ë°€ë²ˆí˜¸ ì˜¤ë¥˜');
    }

    function startGame() {
        const homeAwayRadio = document.querySelector('input[name="homeAway"]:checked');
        const isHome = homeAwayRadio ? (homeAwayRadio.value === 'home') : false;
        gameState.myTeam = isHome ? 'home' : 'away';
        gameState.oppName = document.getElementById('oppName').value || 'ìƒëŒ€íŒ€';
        
        gameState.lineup = [];
        for(let i=0; i<9; i++) {
            const val = document.getElementById('pName' + i).value;
            gameState.lineup.push({ 
                name: val || `íƒ€ì${i+1}`, 
                ab:0, h:0, rbi:0, run:0, bb:0, k:0 
            });
        }
        
        document.getElementById('setupSection').style.display = 'none';
        document.getElementById('gameSection').style.display = 'block';
        syncAll(); renderBoard();
    }

    // === â˜… ìƒì„¸ ë©”ë‰´ ë¡œì§ (í™•ì¥ë¨) ===
    function handleAction(act) {
        if(act.includes('_menu')) openModal(act);
        else processPlay(act);
    }

    function openModal(menuType) {
        const m = document.getElementById('actionModal');
        const b = document.getElementById('amButtons');
        const t = document.getElementById('amTitle');
        b.innerHTML = ''; m.style.display = 'flex';
        let btns = [];

        if(menuType === 'gnd_menu') {
            t.textContent = 'ë•…ë³¼ / ì•¼ìˆ˜ì„ íƒ';
            btns = [
                {txt:'ë•…ë³¼ ì•„ì›ƒ', code:'go'},
                {txt:'ì•¼ìˆ˜ì„ íƒ (íƒ€ì ì„¸ì´í”„)', code:'fc_safe'},
                {txt:'ë³‘ì‚´íƒ€ (ì£¼ì+íƒ€ì ì•„ì›ƒ)', code:'dp'}
            ];
        } else if (menuType === 'fly_menu') {
            t.textContent = 'ëœ¬ê³µ / ë¼ì¸ë“œë¼ì´ë¸Œ';
            btns = [
                {txt:'ëœ¬ê³µ ì•„ì›ƒ (Fly)', code:'fo'},
                {txt:'ë‚´ì•¼ ëœ¬ê³µ (Pop)', code:'po'},
                {txt:'ì§ì„ íƒ€ ì•„ì›ƒ (Line)', code:'ld'},
                {txt:'íŒŒìš¸ í”Œë¼ì´', code:'ff'}
            ];
        } else if (menuType === 'k_menu') {
            t.textContent = 'ì‚¼ì§„';
            btns = [
                {txt:'í—›ìŠ¤ìœ™ ì‚¼ì§„', code:'k_swing'},
                {txt:'ë£¨í‚¹ ì‚¼ì§„', code:'k_look'},
                {txt:'ë‚«ì•„ì›ƒ ì¶œë£¨', code:'not_out'}
            ];
        } else if (menuType === 'sac_menu') {
            t.textContent = 'í¬ìƒíƒ€ (íƒ€ìˆ˜ ë¯¸í¬í•¨)';
            btns = [
                {txt:'í¬ìƒ ë²ˆíŠ¸', code:'sac_bunt'},
                {txt:'í¬ìƒ í”Œë¼ì´', code:'sac_fly'}
            ];
        } else if (menuType === 'bb_menu') {
            t.textContent = 'ì‚¬ì‚¬êµ¬';
            btns = [
                {txt:'ë³¼ë„· (BB)', code:'bb'},
                {txt:'ëª¸ì— ë§ëŠ” ê³µ (HBP)', code:'hbp'},
                {txt:'ê³ ì˜ì‚¬êµ¬ (IBB)', code:'ibb'}
            ];
        } else if (menuType === 'err_menu') {
            t.textContent = 'ì‹¤ì±… (Error)';
            btns = [
                {txt:'í¬êµ¬/ì†¡êµ¬ ì‹¤ì±… (íƒ€ì ì„¸ì´í”„)', code:'error_safe'},
                {txt:'ì£¼ìë§Œ ì¶”ê°€ ì§„ë£¨', code:'error_adv'}
            ];
        } else if (menuType === 'etc_menu') {
            t.textContent = 'ê¸°íƒ€ ìƒí™©';
            btns = [
                {txt:'ë„ë£¨ ì„±ê³µ', code:'sb'},
                {txt:'í­íˆ¬ (Wild Pitch)', code:'wp'},
                {txt:'í¬ì¼ (Passed Ball)', code:'pb'}
            ];
        }

        btns.forEach(item => {
            const btn = document.createElement('button');
            btn.className = 'am-btn';
            btn.textContent = item.txt;
            btn.onclick = () => { processPlay(item.code); closeModal(); };
            b.appendChild(btn);
        });
    }

    function closeModal() { document.getElementById('actionModal').style.display = 'none'; }

    // === â˜… í”Œë ˆì´ ì²˜ë¦¬ (ì„¸ë¶„í™”ë¨) ===
    function processPlay(code) {
        const batter = gameState.lineup[gameState.currentBatterIdx];
        let logText = `[${gameState.currentBatterIdx+1}ë²ˆ ${batter.name}] : `;
        
        // 1. íƒ€ê²© ê²°ê³¼ (Hit)
        if(['1b','2b','3b','hr','inf_hit'].includes(code)) {
            batter.ab++; batter.h++;
            if(code==='1b') { logText += 'ì¢Œì „ ì•ˆíƒ€!'; advanceRunners(1); gameState.runners.b1 = batter.name; }
            else if(code==='2b') { logText += 'ìš°ì¤‘ê°„ 2ë£¨íƒ€!'; advanceRunners(2); gameState.runners.b2 = batter.name; }
            else if(code==='3b') { logText += '3ë£¨íƒ€!!!'; advanceRunners(3); gameState.runners.b3 = batter.name; }
            else if(code==='hr') { logText += 'í™ˆëŸ°~~~~!!!!'; batter.rbi++; batter.run++; advanceRunners(4); }
            else if(code==='inf_hit') { logText += 'ë‚´ì•¼ ì•ˆíƒ€!'; advanceRunners(1); gameState.runners.b1 = batter.name; }
        }
        
        // 2. ì•„ì›ƒ (Out)
        else if(['go','fo','po','ld','ff','k_swing','k_look'].includes(code)) {
            batter.ab++;
            if(code.startsWith('k')) { batter.k++; logText += (code==='k_look'?'ë£¨í‚¹ ì‚¼ì§„':'í—›ìŠ¤ìœ™ ì‚¼ì§„'); }
            else if(code==='go') logText += 'ë•…ë³¼ ì•„ì›ƒ';
            else if(code==='fo') logText += 'ì¤‘ê²¬ìˆ˜ ëœ¬ê³µ ì•„ì›ƒ';
            else if(code==='po') logText += 'ë‚´ì•¼ í”Œë¼ì´ ì•„ì›ƒ';
            else if(code==='ld') logText += 'ì§ì„ íƒ€ ì•„ì›ƒ';
            else if(code==='ff') logText += 'íŒŒìš¸ í”Œë¼ì´ ì•„ì›ƒ';
            addOut();
        }

        // 3. í¬ìƒíƒ€ (Sacrifice) - íƒ€ìˆ˜ ì•ˆ ì˜¤ë¦„
        else if(code === 'sac_bunt') {
            logText += 'í¬ìƒ ë²ˆíŠ¸ ì„±ê³µ (ì£¼ì ì§„ë£¨)';
            addOut(); 
            // ë²ˆíŠ¸ëŠ” ë³´í†µ ì£¼ìë§Œ 1ë£¨ì”© ë³´ëƒ„
            pushRunnersForBunt(); 
            if(gameState.runners.b1) gameState.runners.b1 = null; // íƒ€ì ì•„ì›ƒ
        }
        else if(code === 'sac_fly') {
            logText += 'í¬ìƒ í”Œë¼ì´! (íƒ€ì  ì¶”ê°€)';
            batter.rbi++; // íƒ€ì  ì¶”ê°€ ê°€ì •
            addOut();
            // 3ë£¨ ì£¼ì ë“ì 
            if(gameState.runners.b3) { addScore(1); gameState.runners.b3 = null; }
        }

        // 4. ì‚¬ì‚¬êµ¬ (Walk)
        else if(['bb','hbp','ibb','not_out'].includes(code)) {
            if(code!=='not_out') batter.bb++;
            else { batter.k++; logText += 'ìŠ¤íŠ¸ë¼ì´í¬ ë‚«ì•„ì›ƒ ì¶œë£¨'; } // ë‚«ì•„ì›ƒì€ ì‚¼ì§„ ê¸°ë¡ + ì¶œë£¨

            if(code==='bb') logText += 'ë³¼ë„· ê±¸ì–´ë‚˜ê°‘ë‹ˆë‹¤.';
            else if(code==='hbp') logText += 'ëª¸ì— ë§ëŠ” ê³µ.';
            else if(code==='ibb') logText += 'ê³ ì˜ì‚¬êµ¬.';
            
            pushRunners(); // ë°€ì–´ë‚´ê¸°
            gameState.runners.b1 = batter.name;
        }

        // 5. íŠ¹ìˆ˜ (Errors / FC)
        else if(code === 'fc_safe') {
            batter.ab++; logText += 'ì•¼ìˆ˜ ì„ íƒìœ¼ë¡œ ì¶œë£¨ (ì„ í–‰ì£¼ì ì•„ì›ƒ)';
            addOut();
            if(gameState.runners.b1) gameState.runners.b1 = null; // 1ë£¨ì£¼ì ì£½ì—ˆë‹¤ê³  ê°€ì •
            gameState.runners.b1 = batter.name;
        }
        else if(code === 'dp') {
            batter.ab++; logText += '6-4-3 ë³‘ì‚´íƒ€!';
            addOut(); addOut();
            if(gameState.runners.b1) gameState.runners.b1 = null; 
        }
        else if(code === 'error_safe') {
            batter.ab++; logText += 'ìƒëŒ€ ì‹¤ì±…ìœ¼ë¡œ ì¶œë£¨!';
            pushRunners(); 
            gameState.runners.b1 = batter.name;
        }

        // 6. ì£¼ì í”Œë ˆì´ (Batter change X)
        else if(code === 'sb') {
            logText = 'ë„ë£¨ ì„±ê³µ!';
            alert("ë„ë£¨: ì£¼ì ìœ„ì¹˜ë¥¼ í´ë¦­í•´ì„œ ìˆ˜ë™ìœ¼ë¡œ ì˜®ê²¨ì£¼ì„¸ìš”.");
        }
        else if(code === 'wp' || code === 'pb') {
            logText = (code==='wp'?'í­íˆ¬':'í¬ì¼') + 'ë¡œ ì£¼ì ì§„ë£¨';
            alert("ì£¼ì ìœ„ì¹˜ë¥¼ í´ë¦­í•´ì„œ ìˆ˜ë™ìœ¼ë¡œ ì˜®ê²¨ì£¼ì„¸ìš”.");
        }
        else if(code === 'error_adv') {
            logText = 'ì‹¤ì±…ìœ¼ë¡œ ì£¼ì ì¶”ê°€ ì§„ë£¨';
            alert("ì£¼ì ìœ„ì¹˜ë¥¼ ìˆ˜ë™ìœ¼ë¡œ ì˜®ê²¨ì£¼ì„¸ìš”.");
        }

        // íƒ€ì êµì²´ (ì£¼ì í”Œë ˆì´ ì œì™¸)
        if(!['sb','wp','pb','error_adv'].includes(code)) {
            nextBatter(); resetCount();
        }

        log(logText); syncAll(); renderBoard();
    }

    // --- ìœ í‹¸ í•¨ìˆ˜ë“¤ ---
    function advanceRunners(bases) {
        let r = gameState.runners; let scored = 0;
        if(r.b3) { r.b3 = null; scored++; }
        if(r.b2) { if(bases>=2) {r.b2=null; scored++;} else {r.b3=r.b2; r.b2=null;} }
        if(r.b1) { if(bases>=3) {r.b1=null; scored++;} else if(bases===2) {r.b3=r.b1; r.b1=null;} else {r.b2=r.b1; r.b1=null;} }
        if(scored>0) { addScore(scored); gameState.lineup[gameState.currentBatterIdx].rbi += scored; }
    }
    
    function pushRunners() { // ë°€ì–´ë‚´ê¸°
        let r = gameState.runners;
        if(r.b1) {
            if(r.b2) {
                if(r.b3) { addScore(1); gameState.lineup[gameState.currentBatterIdx].rbi++; } 
                else r.b3=r.b2;
            } else r.b2=r.b1;
        }
    }

    function pushRunnersForBunt() { // ë²ˆíŠ¸ ì‹œ ì£¼ìë§Œ ì§„ë£¨ (ë‹¨ìˆœí™”)
        let r = gameState.runners;
        if(r.b2) { r.b3 = r.b2; r.b2 = null; }
        if(r.b1) { r.b2 = r.b1; r.b1 = null; }
    }

    function addOut() {
        gameState.bso.o++;
        if(gameState.bso.o >= 3) {
            alert("3ì•„ì›ƒ! ê³µìˆ˜êµëŒ€ í•˜ì„¸ìš”.");
            gameState.bso.o = 0;
            gameState.runners = {b1:null, b2:null, b3:null};
        }
    }

    function addScore(n) {
        if(gameState.myTeam === 'home') gameState.score.home += n;
        else gameState.score.away += n;
    }

    function nextBatter() { gameState.currentBatterIdx = (gameState.currentBatterIdx + 1) % 9; }
    function resetCount() { gameState.bso.b=0; gameState.bso.s=0; }
    
    function changeInning(delta) {
        let s = gameState.inningStr; let num = parseInt(s); let isTop = s.includes('ì´ˆ');
        if(delta > 0) { if(isTop) gameState.inningStr = `${num}íšŒë§`; else gameState.inningStr = `${num+1}íšŒì´ˆ`; } 
        else { if(num===1 && isTop) return; if(!isTop) gameState.inningStr = `${num}íšŒì´ˆ`; else gameState.inningStr = `${num-1}íšŒë§`; }
        syncAll(); renderBoard();
    }

    function sendManualText() {
        const t = document.getElementById('comment').value;
        if(t) { log(t); document.getElementById('comment').value=''; }
    }
    
    function resetGame() {
        if(confirm("ì •ë§ ì´ˆê¸°í™”?")) {
            set(ref(db, 'status'), null); set(ref(db, 'logs'), null);
            alert("ì´ˆê¸°í™”ë¨"); location.reload();
        }
    }

    function syncAll() {
        update(ref(db, 'status'), {
            score: gameState.score, inning: gameState.inningStr, bso: gameState.bso, runners: gameState.runners,
            teams: { home: (gameState.myTeam==='home'?'TAURUS':gameState.oppName), away: (gameState.myTeam==='away'?'TAURUS':gameState.oppName) },
            currentBatterIdx: gameState.currentBatterIdx, lineup: gameState.lineup
        });
    }

    function log(msg) {
        const now = new Date();
        push(ref(db, 'logs'), { text: msg, time: `${now.getHours()}:${String(now.getMinutes()).padStart(2,'0')}`, notice: false });
    }

    function renderBoard() {
        const g = gameState;
        document.getElementById('scAway').textContent = g.score.away;
        document.getElementById('scHome').textContent = g.score.home;
        document.getElementById('dispAway').textContent = (g.myTeam==='away'?'TAURUS':g.oppName);
        document.getElementById('dispHome').textContent = (g.myTeam==='home'?'TAURUS':g.oppName);
        document.getElementById('inningVal').textContent = g.inningStr;
        
        document.getElementById('cntB').value = g.bso.b;
        document.getElementById('cntS').value = g.bso.s;
        document.getElementById('cntO').value = g.bso.o;
        
        const setBase = (id, name) => {
            const el = document.getElementById(id);
            if(name) { el.classList.add('active'); el.title = name; }
            else { el.classList.remove('active'); el.title = ''; }
        };
        setBase('base1', g.runners.b1);
        setBase('base2', g.runners.b2);
        setBase('base3', g.runners.b3);
        
        if(g.lineup[g.currentBatterIdx]) {
            document.getElementById('currentBatterDisplay').textContent = 
                `í˜„ì¬ íƒ€ì„: ${g.lineup[g.currentBatterIdx].name} (${g.currentBatterIdx+1}ë²ˆ)`;
        }
        
        const tbody = document.getElementById('lineupTableBody');
        tbody.innerHTML = '';
        g.lineup.forEach((p, i) => {
            const isCur = (i === g.currentBatterIdx);
            tbody.innerHTML += `
                <tr class="${isCur ? 'current-batter' : ''}" style="cursor:pointer;" onclick="window.changeBatter(${i})">
                    <td>${i+1}</td>
                    <td class="bs-name">${p.name}</td>
                    <td>${p.ab}</td>
                    <td style="color:red; font-weight:bold;">${p.h}</td>
                    <td>${p.rbi}</td>
                    <td>${p.run}</td>
                    <td>${p.bb}</td>
                    <td>${p.k}</td>
                </tr>
            `;
        });
    }

    window.changeBatter = (idx) => {
        if(confirm(`${idx+1}ë²ˆ íƒ€ìë¡œ ìˆœì„œë¥¼ ê°•ì œ ë³€ê²½í•˜ì‹œê² ìŠµë‹ˆê¹Œ?`)) {
            gameState.currentBatterIdx = idx; syncAll(); renderBoard();
        }
    };

    onValue(ref(db, 'status'), (snap) => {
        const d = snap.val();
        if(d) {
            gameState = { ...gameState, ...d };
            if(d.inning) gameState.inningStr = d.inning;
            renderBoard();
            document.getElementById('setupSection').style.display = 'none';
            document.getElementById('gameSection').style.display = 'block';
        }
    });
  </script>
</body>
</html>